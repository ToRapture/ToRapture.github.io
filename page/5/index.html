<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"torapture.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Some notes">
<meta property="og:type" content="website">
<meta property="og:title" content="ToRapture&#39;s Blog">
<meta property="og:url" content="https://torapture.github.io/page/5/index.html">
<meta property="og:site_name" content="ToRapture&#39;s Blog">
<meta property="og:description" content="Some notes">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ToRapture">
<meta property="article:tag" content="ToRapture, Linux">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://torapture.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>ToRapture's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ToRapture's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">A Programmer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%8D%E4%B8%AD%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86%E9%80%92%E5%BD%92%E8%BD%AC%E5%BE%AA%E7%8E%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%8D%E4%B8%AD%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86%E9%80%92%E5%BD%92%E8%BD%AC%E5%BE%AA%E7%8E%AF/" class="post-title-link" itemprop="url">二叉树前中后序遍历递归转循环</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-29 17:39:00 17:39:00" itemprop="dateCreated datePublished" datetime="2019-12-29T17:39:00+08:00">2019-12-29 17:39:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>通过观察递归实现，用循环和栈模拟递归实现中结点入栈和出栈的过程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DBG(x) cerr &lt;&lt; #x &lt;&lt; <span class="meta-string">&quot; = &quot;</span> &lt;&lt; x &lt;&lt; endl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    Node *left, *right;</span><br><span class="line"></span><br><span class="line">    Node() : left(<span class="literal">NULL</span>), right(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> val) : val(val), left(<span class="literal">NULL</span>), right(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> StackState &#123;</span><br><span class="line">    AFTER_PUSH_ROOT = <span class="number">0</span>,</span><br><span class="line">    AFTER_PUSH_LEFT = <span class="number">1</span>,</span><br><span class="line">    AFTER_PUSH_RIGHT = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs_pre_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    ret.push_back(root-&gt;val);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) dfs_pre_order(root-&gt;left, ret);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) dfs_pre_order(root-&gt;right, ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs_in_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) dfs_in_order(root-&gt;left, ret);</span><br><span class="line">    ret.push_back(root-&gt;val);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) dfs_in_order(root-&gt;right, ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs_post_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) dfs_post_order(root-&gt;left, ret);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) dfs_post_order(root-&gt;right, ret);</span><br><span class="line">    ret.push_back(root-&gt;val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pre_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">pair</span>&lt;Node *, StackState&gt;&gt; stk;</span><br><span class="line">    stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(root, AFTER_PUSH_ROOT));</span><br><span class="line">    <span class="keyword">while</span> (!stk.empty()) &#123;</span><br><span class="line">        <span class="built_in">pair</span>&lt;Node *, StackState&gt; &amp;top = stk.top();</span><br><span class="line">        <span class="keyword">switch</span> (top.second) &#123;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_ROOT:</span><br><span class="line">                ret.push_back(top.first-&gt;val);</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;left) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;left, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_LEFT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_LEFT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;right) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;right, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_RIGHT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_RIGHT:</span><br><span class="line">                stk.pop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">in_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">pair</span>&lt;Node *, StackState&gt;&gt; stk;</span><br><span class="line">    stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(root, AFTER_PUSH_ROOT));</span><br><span class="line">    <span class="keyword">while</span> (!stk.empty()) &#123;</span><br><span class="line">        <span class="built_in">pair</span>&lt;Node *, StackState&gt; &amp;top = stk.top();</span><br><span class="line">        <span class="keyword">switch</span> (top.second) &#123;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_ROOT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;left) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;left, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_LEFT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_LEFT:</span><br><span class="line">                ret.push_back(top.first-&gt;val);</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;right) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;right, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_RIGHT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_RIGHT:</span><br><span class="line">                stk.pop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">post_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">pair</span>&lt;Node *, StackState&gt;&gt; stk;</span><br><span class="line">    stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(root, AFTER_PUSH_ROOT));</span><br><span class="line">    <span class="keyword">while</span> (!stk.empty()) &#123;</span><br><span class="line">        <span class="built_in">pair</span>&lt;Node *, StackState&gt; &amp;top = stk.top();</span><br><span class="line">        <span class="keyword">switch</span> (top.second) &#123;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_ROOT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;left) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;left, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_LEFT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_LEFT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;right) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;right, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_RIGHT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_RIGHT:</span><br><span class="line">                ret.push_back(top.first-&gt;val);</span><br><span class="line">                stk.pop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Node *<span class="title">get_tree</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    Node *root = <span class="keyword">new</span> Node(random());</span><br><span class="line">    <span class="built_in">vector</span>&lt;Node *&gt; nodes;</span><br><span class="line">    nodes.push_back(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> pos = random() * random() * random() % nodes.size();</span><br><span class="line">        <span class="keyword">if</span> (nodes[pos]-&gt;left == <span class="literal">NULL</span> &amp;&amp; nodes[pos]-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (random() % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                nodes[pos]-&gt;left = <span class="keyword">new</span> Node(random());</span><br><span class="line">                nodes.push_back(nodes[pos]-&gt;left);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nodes[pos]-&gt;right = <span class="keyword">new</span> Node(random());</span><br><span class="line">                nodes.push_back(nodes[pos]-&gt;right);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodes[pos]-&gt;left) &#123;</span><br><span class="line">            nodes[pos]-&gt;right = <span class="keyword">new</span> Node(random());</span><br><span class="line">            nodes.push_back(nodes[pos]-&gt;right);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nodes[pos]-&gt;left = <span class="keyword">new</span> Node(random());</span><br><span class="line">            nodes.push_back(nodes[pos]-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nodes[pos]-&gt;left &amp;&amp; nodes[pos]-&gt;right) &#123;</span><br><span class="line">            nodes.erase(nodes.begin() + pos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_tree</span><span class="params">(Node *root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) free_tree(root-&gt;left);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) free_tree(root-&gt;right);</span><br><span class="line">    <span class="keyword">delete</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_pre_order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node *tree = get_tree(<span class="number">100000</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; dfs_ret, ret;</span><br><span class="line"></span><br><span class="line">    dfs_pre_order(tree, dfs_ret);</span><br><span class="line">    pre_order(tree, ret);</span><br><span class="line">    assert(dfs_ret == ret);</span><br><span class="line"></span><br><span class="line">    free_tree(tree);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_in_order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node *tree = get_tree(<span class="number">100000</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; dfs_ret, ret;</span><br><span class="line"></span><br><span class="line">    dfs_in_order(tree, dfs_ret);</span><br><span class="line">    in_order(tree, ret);</span><br><span class="line">    assert(dfs_ret == ret);</span><br><span class="line"></span><br><span class="line">    free_tree(tree);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_post_order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node *tree = get_tree(<span class="number">100000</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; dfs_ret, ret;</span><br><span class="line"></span><br><span class="line">    dfs_post_order(tree, dfs_ret);</span><br><span class="line">    post_order(tree, ret);</span><br><span class="line">    assert(dfs_ret == ret);</span><br><span class="line"></span><br><span class="line">    free_tree(tree);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    test_pre_order();</span><br><span class="line">    test_in_order();</span><br><span class="line">    test_post_order();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/29/Median-of-Two-Sorted-Arrays/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/29/Median-of-Two-Sorted-Arrays/" class="post-title-link" itemprop="url">Median of Two Sorted Arrays</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-29 15:01:00 15:01:00" itemprop="dateCreated datePublished" datetime="2019-12-29T15:01:00+08:00">2019-12-29 15:01:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>https://leetcode.com/problems/median-of-two-sorted-arrays/</p>
<p>函数<span class="math inline">\(kth\)</span>表示归并两个数组时得到的第<span class="math inline">\(k\)</span>个元素，函数的计算过程为，每次从<span class="math inline">\(A\)</span>或<span class="math inline">\(B\)</span>数组的其中一个数组中，找出<span class="math inline">\(p\)</span>个元素，这<span class="math inline">\(p\)</span>个元素不大于归并得到的第<span class="math inline">\(k\)</span>个元素，接着把这<span class="math inline">\(p\)</span>个元素排除掉，继续在<span class="math inline">\(A\)</span>和<span class="math inline">\(B\)</span>数组的剩余部分找归并<span class="math inline">\(A\)</span>和<span class="math inline">\(B\)</span>数组剩余部分后得到的第<span class="math inline">\(k-p\)</span>个元素。 特殊地，当<span class="math inline">\(k=1\)</span>或有一个数组为空时可以直接得到答案。 每次找到一个<span class="math inline">\(p \in [1, \lfloor \frac{k}{2} \rfloor]\)</span>，假设<span class="math inline">\(A[0:p]\)</span>和<span class="math inline">\(B[0:p]\)</span>都在归并的结果内，比较<span class="math inline">\(A_p\)</span>和<span class="math inline">\(B_p\)</span>，如果<span class="math inline">\(A_p &lt; B_p\)</span>则说明<span class="math inline">\(A\)</span>中前<span class="math inline">\(p\)</span>个元素都不大于归并后的第<span class="math inline">\(k\)</span>个元素，否则说明<span class="math inline">\(B\)</span>中前<span class="math inline">\(p\)</span>个元素都不大于归并后的第<span class="math inline">\(k\)</span>个元素。</p>
<p>当<span class="math inline">\(p\)</span>取<span class="math inline">\(\lfloor \frac{k}{2} \rfloor\)</span>时时间复杂度为<span class="math inline">\(O(log(k)) = O(log(n + m))\)</span>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums1, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = nums1.size() + nums2.size();</span><br><span class="line">        <span class="keyword">if</span> (n % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> kth(nums1, <span class="number">0</span>, nums2, <span class="number">0</span>, n / <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> (kth(nums1, <span class="number">0</span>, nums2, <span class="number">0</span>, n / <span class="number">2</span>) + kth(nums1, <span class="number">0</span>, nums2, <span class="number">0</span>, n / <span class="number">2</span> + <span class="number">1</span>)) / <span class="number">2.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">kth</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;nums1, <span class="keyword">int</span> n1, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;nums2, <span class="keyword">int</span> n2, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums1.size() - n1 &gt; nums2.size() - n2)</span><br><span class="line">            <span class="keyword">return</span> kth(nums2, n2, nums1, n1, k);</span><br><span class="line">        <span class="keyword">if</span> (nums1.size() - n1 == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> nums2[n2 + k - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> min(nums1[n1], nums2[n2]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> p = min(k / <span class="number">2</span>, <span class="keyword">int</span>(nums1.size() - n1));</span><br><span class="line">        <span class="keyword">if</span> (nums1[n1 + p - <span class="number">1</span>] &lt; nums2[n2 + p - <span class="number">1</span>])</span><br><span class="line">            <span class="keyword">return</span> kth(nums1, n1 + p, nums2, n2, k - p);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> kth(nums1, n1, nums2, n2 + p, k - p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/24/wait%E5%92%8Csignal%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/24/wait%E5%92%8Csignal%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">wait和signal测试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-24 11:33:00 11:33:00" itemprop="dateCreated datePublished" datetime="2019-12-24T11:33:00+08:00">2019-12-24 11:33:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -ra</span><br><span class="line">Linux Rapture 4.15.0-72-generic #81~16.04.1-Ubuntu SMP Tue Nov 26 16:34:21 UTC 2019 x86_64 x86_64 x86_64 GNU&#x2F;Linux</span><br></pre></td></tr></table></figure>
<p><code>signal.cpp</code> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;signal num: %d\n&quot;</span>, num);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sleep over\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argc;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--handle&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            signal(atoi(argv[i + <span class="number">1</span>]), handle);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pid: %d\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, time(<span class="literal">NULL</span>));</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;signal &amp;</span><br><span class="line">[1] 6223</span><br><span class="line">pid: 6223</span><br><span class="line">1577155844</span><br><span class="line">1577155845</span><br><span class="line">$ kill -KILL 6223</span><br><span class="line">[1]  + 6223 killed     .&#x2F;signal</span><br><span class="line"></span><br><span class="line">$ .&#x2F;signal --handle 9 &amp;</span><br><span class="line">[1] 6261</span><br><span class="line">pid: 6261</span><br><span class="line">1577155864</span><br><span class="line">1577155865</span><br><span class="line">$ kill -KILL 6261</span><br><span class="line">[1]  + 6261 killed     .&#x2F;signal --handle 9</span><br></pre></td></tr></table></figure> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;signal &amp;</span><br><span class="line">[1] 6471</span><br><span class="line">pid: 6471</span><br><span class="line">1577156088</span><br><span class="line">1577156089</span><br><span class="line">$ kill -SIGSTOP 6471</span><br><span class="line">[1]  + 6471 suspended (signal)  .&#x2F;signal</span><br><span class="line">......</span><br><span class="line">$ kill -SIGCONT 6471</span><br><span class="line">1577156113</span><br><span class="line">1577156114</span><br><span class="line">1577156115</span><br><span class="line">1577156116</span><br><span class="line">1577156117</span><br><span class="line"></span><br><span class="line">$ .&#x2F;signal --handle 18 19 &amp;</span><br><span class="line">[1] 6566</span><br><span class="line">pid: 6566</span><br><span class="line">1577156249</span><br><span class="line">1577156250</span><br><span class="line">$ kill -SIGSTOP 6566</span><br><span class="line">[1]  + 6566 suspended (signal)  .&#x2F;signal --handle 18 19</span><br><span class="line">......</span><br><span class="line">$ kill -SIGCONT 6566</span><br><span class="line">signal num: 18</span><br><span class="line">sleep over</span><br><span class="line">1577156270</span><br><span class="line">1577156271</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;signal --handle 15 &amp;</span><br><span class="line">[1] 7148</span><br><span class="line">pid: 7148</span><br><span class="line">1577156583</span><br><span class="line">1577156584</span><br><span class="line">1577156585</span><br><span class="line">$ kill -SIGTERM 7148</span><br><span class="line">$ kill -SIGTERM 7148</span><br><span class="line">$ kill -SIGTERM 7148</span><br><span class="line">$ kill -SIGTERM 7148</span><br><span class="line">$ kill -SIGTERM 7148</span><br><span class="line">signal num: 15</span><br><span class="line">sleep over</span><br><span class="line">signal num: 15</span><br><span class="line">sleep over</span><br><span class="line">1577156597</span><br><span class="line">1577156598</span><br><span class="line">1577156599</span><br><span class="line">1577156600</span><br><span class="line">1577156601</span><br><span class="line">......</span><br><span class="line">$ kill -KILL 7148</span><br><span class="line">[1]  + 7148 killed     .&#x2F;signal --handle 15</span><br></pre></td></tr></table></figure>
<p><code>wait.cpp</code> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;signal num: %d\n&quot;</span>, num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> options = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> divide_zero = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> invalid_memory = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argc;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--WUNTRACED&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            options |= WUNTRACED;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--WNOHANG&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            options |= WNOHANG;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--WCONTINUED&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            options |= WCONTINUED;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--handle&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            signal(atoi(argv[i + <span class="number">1</span>]), handle);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--divide-zero&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            divide_zero = <span class="literal">true</span>;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[i], <span class="string">&quot;--invalid-memory&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            invalid_memory = <span class="literal">true</span>;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> cpid, w;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line"></span><br><span class="line">    cpid = fork();</span><br><span class="line">    <span class="keyword">if</span> (cpid == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Child PID is %ld\n&quot;</span>, (<span class="keyword">long</span>) getpid());</span><br><span class="line">        <span class="keyword">if</span> (divide_zero) &#123;</span><br><span class="line">            <span class="keyword">int</span> x = <span class="number">1337</span>;</span><br><span class="line">            <span class="keyword">int</span> y = x / <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, y);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (invalid_memory) &#123;</span><br><span class="line">            *(<span class="keyword">int</span> *) <span class="number">0</span> = <span class="number">1337</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;time: %d\n&quot;</span>, time(<span class="literal">NULL</span>));</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Father PID is %ld\n&quot;</span>, (<span class="keyword">long</span>) getpid());</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            w = waitpid(cpid, &amp;status, options);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;w: %d, WIFEXITED: %d, WIFSIGNALED: %d, WIFSTOPPED: %d, WIFCONTINUED: %d\n&quot;</span>,</span><br><span class="line">                   w, WIFEXITED(status), WIFSIGNALED(status), WIFSTOPPED(status), WIFCONTINUED(status));</span><br><span class="line">            <span class="keyword">if</span> (w == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (w == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;waitpid error\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (WIFEXITED(status)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;exited, status=%d\n&quot;</span>, WEXITSTATUS(status));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WIFSIGNALED(status)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;killed by signal %d\n&quot;</span>, WTERMSIG(status));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WIFSTOPPED(status)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;stopped by signal %d\n&quot;</span>, WSTOPSIG(status));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (WIFCONTINUED(status)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;continued\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> ((!WIFEXITED(status) &amp;&amp; !WIFSIGNALED(status)) || w == <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;wait &amp;</span><br><span class="line">[1] 7523</span><br><span class="line">Father PID is 7523</span><br><span class="line">Child PID is 7525</span><br><span class="line">time: 1577156913</span><br><span class="line">time: 1577156914</span><br><span class="line">time: 1577156915</span><br><span class="line">time: 1577156916</span><br><span class="line">$ kill 7525</span><br><span class="line">w: 7525, WIFEXITED: 0, WIFSIGNALED: 1, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">killed by signal 15</span><br><span class="line"></span><br><span class="line">$ .&#x2F;wait --handle 15</span><br><span class="line">Father PID is 7566</span><br><span class="line">Child PID is 7567</span><br><span class="line">time: 1577156938</span><br><span class="line">time: 1577156939</span><br><span class="line">time: 1577156940</span><br><span class="line">time: 1577156941</span><br><span class="line">$ kill 7567</span><br><span class="line">signal num: 15</span><br><span class="line">time: 1577156941</span><br><span class="line">time: 1577156942</span><br><span class="line">$ kill -KILL 7567</span><br><span class="line">w: 7567, WIFEXITED: 0, WIFSIGNALED: 1, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">killed by signal 9</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;wait --divide-zero</span><br><span class="line">Child PID is 7744</span><br><span class="line">Father PID is 7743</span><br><span class="line">w: 7744, WIFEXITED: 0, WIFSIGNALED: 1, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">killed by signal 8</span><br><span class="line"></span><br><span class="line">$ .&#x2F;wait --divide-zero --handle 8</span><br><span class="line">Father PID is 7716</span><br><span class="line">Child PID is 7717</span><br><span class="line">signal num: 8</span><br><span class="line">signal num: 8</span><br><span class="line">signal num: 8</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;wait --invalid-memory</span><br><span class="line">Father PID is 8085</span><br><span class="line">Child PID is 8086</span><br><span class="line">w: 8086, WIFEXITED: 0, WIFSIGNALED: 1, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">killed by signal 11</span><br><span class="line"></span><br><span class="line">$ .&#x2F;wait --invalid-memory --handle 11</span><br><span class="line">Father PID is 8432</span><br><span class="line">Child PID is 8433</span><br><span class="line">signal num: 11</span><br><span class="line">signal num: 11</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;wait --WNOHANG &amp;</span><br><span class="line">Father PID is 9033</span><br><span class="line">Child PID is 9034</span><br><span class="line">w: 0, WIFEXITED: 1, WIFSIGNALED: 0, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">w: 0, WIFEXITED: 1, WIFSIGNALED: 0, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">time: 1577157886</span><br><span class="line">time: 1577157887</span><br><span class="line">......</span><br><span class="line">$ kill 9034</span><br><span class="line">w: 9034, WIFEXITED: 0, WIFSIGNALED: 1, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">killed by signal 15</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;wait --WUNTRACED --WCONTINUED --handle 15 &amp;</span><br><span class="line">[1] 9312</span><br><span class="line">Child PID is 9314</span><br><span class="line">time: 1577158011</span><br><span class="line">Father PID is 9312</span><br><span class="line">time: 1577158013</span><br><span class="line">time: 1577158014</span><br><span class="line">$ kill 9314</span><br><span class="line">signal num: 15</span><br><span class="line">time: 1577158015</span><br><span class="line">time: 1577158016</span><br><span class="line">......</span><br><span class="line">time: 1577158025</span><br><span class="line">time: 1577158026</span><br><span class="line">time: 1577158027</span><br><span class="line">time: 1577158028</span><br><span class="line">$ kill -SIGSTOP 9314</span><br><span class="line">w: 9314, WIFEXITED: 0, WIFSIGNALED: 0, WIFSTOPPED: 1, WIFCONTINUED: 0</span><br><span class="line">stopped by signal 19</span><br><span class="line">$ kill -SIGCONT 9314</span><br><span class="line">w: 9314, WIFEXITED: 0, WIFSIGNALED: 0, WIFSTOPPED: 0, WIFCONTINUED: 1</span><br><span class="line">continued</span><br><span class="line">time: 1577158038</span><br><span class="line">...</span><br><span class="line">time: 1577158041</span><br><span class="line">$ kill -SIGKILL 9314</span><br><span class="line">w: 9314, WIFEXITED: 0, WIFSIGNALED: 1, WIFSTOPPED: 0, WIFCONTINUED: 0</span><br><span class="line">killed by signal 9</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/17/NSQ%E5%AD%A6%E4%B9%A0-%E9%80%BB%E8%BE%91%E6%A2%B3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/17/NSQ%E5%AD%A6%E4%B9%A0-%E9%80%BB%E8%BE%91%E6%A2%B3%E7%90%86/" class="post-title-link" itemprop="url">NSQ学习 逻辑梳理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-17 16:27:00 16:27:00" itemprop="dateCreated datePublished" datetime="2019-12-17T16:27:00+08:00">2019-12-17 16:27:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="消费者连接nsqd或nsqlookupd">消费者连接NSQD或NSQLookupd</h1>
<p>消费者可以连接多个<code>NSQLookupd</code>，消费者从每一个<code>NSQLookupd</code>查询拥有需要消费的<code>Topic</code>的<code>NSQD</code>，并与查询得到的每一个<code>NSQD</code>建立连接。 每当<code>NSQD</code>中<code>Topic</code>或<code>Channle</code>出现了变动，<code>NSQD</code>会通知每一个与它相连的<code>NSQLookupd</code>。</p>
<h1 id="一条消息的生命周期">一条消息的生命周期</h1>
<p>一条消息首先被生产者投递到<code>NSQD</code>的<code>Topic</code>，然后由<code>Topic.messagePump</code>这个方法分发给<code>Topic</code>的<code>Channel</code>。</p>
<p><code>nsq/nsqd/protocol_v2.go</code>中的<code>protocolV2.IOLoop</code>方法一边根据客户端的接收情况把<code>Channel</code>中的消息发给客户端（<code>protocolV2.messagePump</code>），一遍处理来自客户端的指令如<code>REQ</code>、<code>FIN</code>等。 消息发给客户端之前，首先push到<code>InFlightQueue</code>这个优先队列中，这个队列可以表示正在处理中的消息。 <code>InFlightQueue</code>是最小堆，用于比较的属性是过期时刻。 每当消费者发送表示执行成功的<code>FIN</code>指令给<code>NSQD</code>时，<code>NSQD</code>就会把执行成功的消息从对应<code>Channel</code>的<code>InFlightQueue</code>删除； 如果直到超时还未收到消费者的<code>FIN</code>指令，那么对应的消息会从<code>InFlightQueue</code>删除，然后重新投递给<code>Channel</code>； 如果收到<code>REQ</code>指令，说明对应消息需要重新执行，这条消息会从<code>InFlightQueue</code>删除然后进入<code>DeferredQueue</code>，等到需要被执行的时刻再重新投递给<code>Channel</code>。 <code>DeferredQueue</code>也是最小堆，用于比较的属性是消息被执行的时刻。</p>
<p><img src="/images/posts/NSQ学习-逻辑梳理/0.png" /></p>
<h1 id="启动和关闭">启动和关闭</h1>
<h2 id="deferredqueue和inflightqueue">DeferredQueue和InFlightQueue</h2>
<p><code>NSQD</code>启动时，通过<code>Metadata</code>生成<code>Topic</code>和<code>Channel</code>，并根据<code>Topic</code>和<code>Channel</code>找到对应的文件队列。</p>
<p><code>NSQD</code>关闭时，每一个<code>Channel</code>的<code>memoryMsgChan</code>的消息会被写到对应的文件队列里，<code>inFlightMessages</code>和<code>deferredMessages</code>同上。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/15/%E8%8E%B7%E5%8F%96CPU%E6%97%B6%E9%97%B4%E5%92%8C%E8%AE%A1%E7%AE%97CPU%E4%BD%BF%E7%94%A8%E7%8E%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/15/%E8%8E%B7%E5%8F%96CPU%E6%97%B6%E9%97%B4%E5%92%8C%E8%AE%A1%E7%AE%97CPU%E4%BD%BF%E7%94%A8%E7%8E%87/" class="post-title-link" itemprop="url">获取CPU时间和计算CPU使用率</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-15 14:48:00 14:48:00" itemprop="dateCreated datePublished" datetime="2019-12-15T14:48:00+08:00">2019-12-15 14:48:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DBG(x) cerr &lt;&lt; #x &lt;&lt; <span class="meta-string">&quot; = &quot;</span> &lt;&lt; x &lt;&lt; endl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cpu_load</span><span class="params">(<span class="keyword">double</span> start, <span class="keyword">double</span> end, <span class="keyword">double</span> used)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> used / (end - start) * <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cpu_time_used_s</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    rusage usage;</span><br><span class="line">    getrusage(RUSAGE_SELF, &amp;usage);</span><br><span class="line">    <span class="keyword">return</span> usage.ru_stime.tv_sec + <span class="keyword">double</span>(usage.ru_stime.tv_usec) / <span class="number">1000000</span> + usage.ru_utime.tv_sec + <span class="keyword">double</span>(usage.ru_utime.tv_usec) / <span class="number">1000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">get_time_s</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    timeval tv;</span><br><span class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> tv.tv_sec + <span class="keyword">double</span>(tv.tv_usec) / <span class="number">1000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> start = get_time_s();</span><br><span class="line"></span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">int</span> x = rand();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">300000000</span>; i++) &#123;</span><br><span class="line">        x ^= rand();</span><br><span class="line">        x |= rand();</span><br><span class="line">        x &amp;= ~rand();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> end = get_time_s();</span><br><span class="line">    <span class="keyword">double</span> real_time_used = end - start;</span><br><span class="line">    <span class="keyword">double</span> cpu_time_used = cpu_time_used_s();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;start: %.3fs, end: %.3fs\n&quot;</span></span><br><span class="line">           <span class="string">&quot;real_time_used: %.3f\n&quot;</span></span><br><span class="line">           <span class="string">&quot;cpu_time_used: %.3fs, cpu_load: %.3f%%\n&quot;</span>,</span><br><span class="line">           start, end, real_time_used, cpu_time_used, cpu_load(start, end, cpu_time_used));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start: 1576392425.566s, end: 1576392438.229s</span><br><span class="line">real_time_used: 12.663</span><br><span class="line">cpu_time_used: 6.230s, cpu_load: 49.201%</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/15/Redis%E5%AD%A6%E4%B9%A0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/15/Redis%E5%AD%A6%E4%B9%A0-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">Redis学习 数据结构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-15 13:34:00 13:34:00" itemprop="dateCreated datePublished" datetime="2019-12-15T13:34:00+08:00">2019-12-15 13:34:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文参考了<a target="_blank" rel="noopener" href="https://github.com/antirez/redis/tree/3.0">Redis源码3.0分支</a>和《Redis设计与实现》。</p>
<h1 id="对象">对象</h1>
<p>Redis基于下面提到的底层数据结构创建了一个对象系统，这个系统包括<code>String</code>、<code>List</code>、<code>Set</code>、<code>Hash</code>、<code>Sorted Set</code>这五种对象，每种对象都用到了至少一种底层数据结构。Redis中的每个对象都由一个<code>redisObject</code>结构表示，该结构中和保存数据有关的三个属性分别是<code>type</code>、<code>encoding</code>和<code>ptr</code>。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Object types */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_STRING 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_LIST 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_SET 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ZSET 3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_HASH 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objects encoding. Some kind of objects like Strings and Hashes can be</span></span><br><span class="line"><span class="comment"> * internally represented in multiple ways. The &#x27;encoding&#x27; field of the object</span></span><br><span class="line"><span class="comment"> * is set to one of this fields for this object. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_RAW 0     <span class="comment">/* Raw representation */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_INT 1     <span class="comment">/* Encoded as integer */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_HT 2      <span class="comment">/* Encoded as hash table */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_ZIPMAP 3  <span class="comment">/* Encoded as zipmap */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_LINKEDLIST 4 <span class="comment">/* Encoded as regular linked list */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_ZIPLIST 5 <span class="comment">/* Encoded as ziplist */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_INTSET 6  <span class="comment">/* Encoded as intset */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_SKIPLIST 7  <span class="comment">/* Encoded as skiplist */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REDIS_ENCODING_EMBSTR 8  <span class="comment">/* Embedded sds string encoding */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:REDIS_LRU_BITS; <span class="comment">/* lru time (relative to server.lruclock) */</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure></p>
<h1 id="底层数据结构">底层数据结构</h1>
<h2 id="sds---simple-dynamic-string">SDS - Simple Dynamic String</h2>
<p>SDS是二进制安全的。</p>
<h3 id="定义">定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *sds;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">free</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="api">API</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Append the specified binary-safe string pointed by &#x27;t&#x27; of &#x27;len&#x27; bytes to the</span></span><br><span class="line"><span class="comment"> * end of the specified sds string &#x27;s&#x27;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * After the call, the passed sds string is no longer valid and all the</span></span><br><span class="line"><span class="comment"> * references must be substituted with the new pointer returned by the call. */</span></span><br><span class="line"><span class="function">sds <span class="title">sdscatlen</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">void</span> *t, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> *<span class="title">sh</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> curlen = sdslen(s);</span><br><span class="line"></span><br><span class="line">    s = sdsMakeRoomFor(s,len);</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    sh = (<span class="keyword">void</span>*) (s-(<span class="keyword">sizeof</span>(struct sdshdr)));</span><br><span class="line">    <span class="built_in">memcpy</span>(s+curlen, t, len);</span><br><span class="line">    sh-&gt;len = curlen+len;</span><br><span class="line">    sh-&gt;<span class="built_in">free</span> = sh-&gt;<span class="built_in">free</span>-len;</span><br><span class="line">    s[curlen+len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Append the specified null termianted C string to the sds string &#x27;s&#x27;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * After the call, the passed sds string is no longer valid and all the</span></span><br><span class="line"><span class="comment"> * references must be substituted with the new pointer returned by the call. */</span></span><br><span class="line"><span class="function">sds <span class="title">sdscat</span><span class="params">(sds s, <span class="keyword">const</span> <span class="keyword">char</span> *t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sdscatlen(s, t, <span class="built_in">strlen</span>(t));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="list">List</h2>
<p>就是大家都学过的链表，方法名也大多顾名思义。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Node, List, and Iterator are the only data structures used currently. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *value;</span><br><span class="line">&#125; listNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listIter</span> &#123;</span></span><br><span class="line">    listNode *next;</span><br><span class="line">    <span class="keyword">int</span> direction;</span><br><span class="line">&#125; listIter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span> &#123;</span></span><br><span class="line">    listNode *head;</span><br><span class="line">    listNode *tail;</span><br><span class="line">    <span class="keyword">void</span> *(*dup)(<span class="keyword">void</span> *ptr);</span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *ptr);</span><br><span class="line">    <span class="keyword">int</span> (*match)(<span class="keyword">void</span> *ptr, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len;</span><br><span class="line">&#125; <span class="built_in">list</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Functions implemented as macros */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listLength(l) ((l)-&gt;len)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listFirst(l) ((l)-&gt;head)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listLast(l) ((l)-&gt;tail)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listPrevNode(n) ((n)-&gt;prev)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listNextNode(n) ((n)-&gt;next)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listNodeValue(n) ((n)-&gt;value)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listSetDupMethod(l,m) ((l)-&gt;dup = (m))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listSetFreeMethod(l,m) ((l)-&gt;free = (m))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listSetMatchMethod(l,m) ((l)-&gt;match = (m))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listGetDupMethod(l) ((l)-&gt;dup)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listGetFree(l) ((l)-&gt;free)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> listGetMatchMethod(l) ((l)-&gt;match)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Prototypes */</span></span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listCreate</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRelease</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listAddNodeHead</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">void</span> *value)</span></span>;</span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listAddNodeTail</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">void</span> *value)</span></span>;</span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listInsertNode</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, listNode *old_node, <span class="keyword">void</span> *value, <span class="keyword">int</span> after)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listDelNode</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, listNode *node)</span></span>;</span><br><span class="line"><span class="function">listIter *<span class="title">listGetIterator</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">int</span> direction)</span></span>;</span><br><span class="line"><span class="function">listNode *<span class="title">listNext</span><span class="params">(listIter *iter)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listReleaseIterator</span><span class="params">(listIter *iter)</span></span>;</span><br><span class="line"><span class="function"><span class="built_in">list</span> *<span class="title">listDup</span><span class="params">(<span class="built_in">list</span> *orig)</span></span>;</span><br><span class="line"><span class="function">listNode *<span class="title">listSearchKey</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">void</span> *key)</span></span>;</span><br><span class="line"><span class="function">listNode *<span class="title">listIndex</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, <span class="keyword">long</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRewind</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, listIter *li)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRewindTail</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>, listIter *li)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">listRotate</span><span class="params">(<span class="built_in">list</span> *<span class="built_in">list</span>)</span></span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="dict">Dict</h2>
<p>Dict的核心就是Separate Chaining Hash Table。 随着操作的不断进行，哈希表保存的键值对会逐渐地增多或减少，为了让哈希表的负载因子（USED/BUCKETS）维持在一个合理的范围之内，当哈希表保存的键值对数量太多或太少时，程序需要对哈希表的大小进行相应的扩展或收缩。</p>
<h3 id="定义-1">定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> *val;</span><br><span class="line">        <span class="keyword">uint64_t</span> u64;</span><br><span class="line">        <span class="keyword">int64_t</span> s64;</span><br><span class="line">        <span class="keyword">double</span> d;</span><br><span class="line">    &#125; v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; dictEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;</span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</span><br><span class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</span><br><span class="line">&#125; dictType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span></span><br><span class="line"><span class="comment"> * implement incremental rehashing, for the old to the new table. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</span><br><span class="line">&#125; dictht;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></span><br><span class="line">    dictType *type;</span><br><span class="line">    <span class="keyword">void</span> *privdata;</span><br><span class="line">    dictht ht[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class="line">    <span class="keyword">int</span> iterators; <span class="comment">/* number of iterators currently running */</span></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure>
<h3 id="核心方法实现">核心方法实现</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Add an element to the target hash table */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictAdd</span><span class="params">(dict *d, <span class="keyword">void</span> *key, <span class="keyword">void</span> *val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dictEntry *entry = dictAddRaw(d,key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!entry) <span class="keyword">return</span> DICT_ERR;</span><br><span class="line">    dictSetVal(d, entry, val);</span><br><span class="line">    <span class="keyword">return</span> DICT_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Low level add. This function adds the entry but instead of setting</span></span><br><span class="line"><span class="comment"> * a value returns the dictEntry structure to the user, that will make</span></span><br><span class="line"><span class="comment"> * sure to fill the value field as he wishes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function is also directly exposed to the user API to be called</span></span><br><span class="line"><span class="comment"> * mainly in order to store non-pointers inside the hash value, example:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * entry = dictAddRaw(dict,mykey);</span></span><br><span class="line"><span class="comment"> * if (entry != NULL) dictSetSignedIntegerVal(entry,1000);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return values:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If key already exists NULL is returned.</span></span><br><span class="line"><span class="comment"> * If key was added, the hash entry is returned to be manipulated by the caller.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">dictEntry *<span class="title">dictAddRaw</span><span class="params">(dict *d, <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    dictEntry *entry;</span><br><span class="line">    dictht *ht;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get the index of the new element, or -1 if</span></span><br><span class="line"><span class="comment">     * the element already exists. */</span></span><br><span class="line">    <span class="keyword">if</span> ((index = _dictKeyIndex(d, key)) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate the memory and store the new entry */</span></span><br><span class="line">    ht = dictIsRehashing(d) ? &amp;d-&gt;ht[<span class="number">1</span>] : &amp;d-&gt;ht[<span class="number">0</span>];</span><br><span class="line">    entry = zmalloc(<span class="keyword">sizeof</span>(*entry));</span><br><span class="line">    entry-&gt;next = ht-&gt;table[index];</span><br><span class="line">    ht-&gt;table[index] = entry;</span><br><span class="line">    ht-&gt;used++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the hash entry fields. */</span></span><br><span class="line">    dictSetKey(d, entry, key);</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">dictEntry *<span class="title">dictFind</span><span class="params">(dict *d, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dictEntry *he;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h, idx, table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].size == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">/* We don&#x27;t have a table at all */</span></span><br><span class="line">    <span class="keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d);</span><br><span class="line">    h = dictHashKey(d, key);</span><br><span class="line">    <span class="keyword">for</span> (table = <span class="number">0</span>; table &lt;= <span class="number">1</span>; table++) &#123;</span><br><span class="line">        idx = h &amp; d-&gt;ht[table].sizemask;</span><br><span class="line">        he = d-&gt;ht[table].table[idx];</span><br><span class="line">        <span class="keyword">while</span>(he) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dictCompareKeys(d, key, he-&gt;key))</span><br><span class="line">                <span class="keyword">return</span> he;</span><br><span class="line">            he = he-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="skiplist">Skiplist</h2>
<p>跳跃表是一种有序数据结构，它通过在每个节点中维持多个指向其他节点的指针，从而达到快速访问节点的目的。 跳跃表支持平均O(logN)、最坏O(N)复杂度的节点查找，还可以通过顺序性操作来批量处理节点。跳跃表的实现比平衡树更简单。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ZSETs use a specialized version of Skiplists */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    robj *obj;</span><br><span class="line">    <span class="keyword">double</span> score;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;</span><br><span class="line">    <span class="keyword">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br><span class="line"></span><br><span class="line"><span class="function">zskiplist *<span class="title">zslCreate</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslFree</span><span class="params">(zskiplist *zsl)</span></span>;</span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, robj *obj)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslDelete</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, robj *obj)</span></span>;</span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslFirstInRange</span><span class="params">(zskiplist *zsl, zrangespec *range)</span></span>;</span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslLastInRange</span><span class="params">(zskiplist *zsl, zrangespec *range)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">zsetLength</span><span class="params">(robj *zobj)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zsetConvert</span><span class="params">(robj *zobj, <span class="keyword">int</span> encoding)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">zslGetRank</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, robj *o)</span></span>;</span><br></pre></td></tr></table></figure>
<p><img src="/images/posts/Redis学习-数据结构/0.png" /></p>
<p>插入时的核心逻辑：</p>
<ol type="1">
<li>找到插入的位置</li>
<li>随机得到新插入节点的level</li>
<li>处理为了插入当前节点穿过的指针和未穿过的指针的指向和跨度</li>
</ol>
<p>删除时的核心逻辑：</p>
<ol type="1">
<li>找到删除的位置</li>
<li>处理要删除的节点穿过的指针和未穿过的指针的指向和跨度</li>
<li>如果可以，减小跳跃表的level</li>
</ol>
<p>下面这个题可以使用平衡树来解，这里为了练习使用跳跃表，注意根据题意特殊处理。 <a target="_blank" rel="noopener" href="https://www.spoj.com/problems/ORDERSET/">SPOJ ORDERSET</a></p>
<h2 id="其他底层数据结构">其他底层数据结构</h2>
<p>其他底层数据结构还包括了压缩列表（Ziplist）和整数集合（Intset）等。</p>
<h1 id="对象的实现">对象的实现</h1>
<p>Redis对象通过<code>encoding</code>属性来设定对象所使用的编码，而不是为特定类型的对象关联一种特定的编码。Redis可以根据不同的使用场景来为一个对象设置不同的编码，从而优化对象在某一场景下的效率。Redis对象还会根据不同的条件，从一种编码转换成另一种编码。</p>
<p>不同类型和编码的对象：</p>
<table>
<thead>
<tr class="header">
<th>类型</th>
<th>编码</th>
<th>对象</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>REDIS_STRING</td>
<td>REDIS_ENCODING_INT</td>
<td>使用整数值实现的字符串对象</td>
</tr>
<tr class="even">
<td>REDIS_STRING</td>
<td>REDIS_ENCODING_EMBSTR</td>
<td>使用 embstr 编码的简单动态字符串实现的字符串对象</td>
</tr>
<tr class="odd">
<td>REDIS_STRING</td>
<td>REDIS_ENCODING_RAW</td>
<td>使用简单动态字符串实现的字符串对象</td>
</tr>
<tr class="even">
<td>REDIS_LIST</td>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>使用压缩列表实现的列表对象</td>
</tr>
<tr class="odd">
<td>REDIS_LIST</td>
<td>REDIS_ENCODING_LINKEDLIST</td>
<td>使用双端链表实现的列表对象</td>
</tr>
<tr class="even">
<td>REDIS_HASH</td>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>使用压缩列表实现的哈希对象</td>
</tr>
<tr class="odd">
<td>REDIS_HASH</td>
<td>REDIS_ENCODING_HT</td>
<td>使用字典实现的哈希对象</td>
</tr>
<tr class="even">
<td>REDIS_SET</td>
<td>REDIS_ENCODING_INTSET</td>
<td>使用整数集合实现的集合对象</td>
</tr>
<tr class="odd">
<td>REDIS_SET</td>
<td>REDIS_ENCODING_HT</td>
<td>使用字典实现的集合对象</td>
</tr>
<tr class="even">
<td>REDIS_ZSET</td>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>使用压缩列表实现的有序集合对象</td>
</tr>
<tr class="odd">
<td>REDIS_ZSET</td>
<td>REDIS_ENCODING_SKIPLIST</td>
<td>使用跳跃表和字典实现的有序集合对象</td>
</tr>
</tbody>
</table>
<h2 id="set">Set</h2>
<p>Set的编码可以是<code>intset</code>或<code>hashtable</code>。 <code>hashtable</code>编码的集合对象使用字典作为底层实现，字典的每个键都是字符串对象，字典的值则全部为NULL。</p>
<h2 id="sorted-set">Sorted Set</h2>
<p>https://news.ycombinator.com/item?id=1171423 Sorted Set的编码可以是<code>ziplist</code>或<code>skiplist</code>。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span> &#123;</span></span><br><span class="line">    dict *dict;</span><br><span class="line">    zskiplist *zsl;</span><br><span class="line">&#125; zset;</span><br></pre></td></tr></table></figure> 底层数据结构编码为<code>skiplist</code>时，<code>redisObject.ptr</code>指向<code>zset</code>类型。 skiplist本身不支持通过key查value，zset使用dict字典为有序集合维护了一个从成员到分值的映射。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/12/Redis%E5%AD%A6%E4%B9%A0-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/12/Redis%E5%AD%A6%E4%B9%A0-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" class="post-title-link" itemprop="url">Redis学习 命令执行</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-12 18:13:00 18:13:00" itemprop="dateCreated datePublished" datetime="2019-12-12T18:13:00+08:00">2019-12-12 18:13:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-17 16:27:02 16:27:02" itemprop="dateModified" datetime="2020-10-17T16:27:02+08:00">2020-10-17 16:27:02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="协议格式">协议格式</h1>
<blockquote>
<p>The way RESP is used in Redis as a request-response protocol is the following:</p>
<ul>
<li>Clients send commands to a Redis server as a RESP Array of Bulk Strings.</li>
<li>The server replies with one of the RESP types according to the command implementation.</li>
</ul>
<p>In RESP, the type of some data depends on the first byte:</p>
</blockquote>
<blockquote>
<ul>
<li>For <strong>Simple Strings</strong> the first byte of the reply is <code>"+"</code></li>
<li>For <strong>Errors</strong> the first byte of the reply is <code>"-"</code></li>
<li>For <strong>Integers</strong> the first byte of the reply is <code>":"</code></li>
<li>For <strong>Bulk Strings</strong> the first byte of the reply is <code>"$"</code></li>
<li>For <strong>Arrays</strong> the first byte of the reply is <code>"*"</code></li>
</ul>
</blockquote>
<p>引用自<a target="_blank" rel="noopener" href="https://redis.io/topics/protocol" class="uri">https://redis.io/topics/protocol</a>。</p>
<hr />
<h1 id="建连与执行命令">建连与执行命令</h1>
<p>Redis服务端通过使用<code>select</code>、<code>poll</code>等I/O多路复用系统调用来实现事件驱动模型。 Redis中的事件分为两类，一类被称为定时事件，如定期执行<code>serverCron</code>来处理过期逻辑、保存RDB、保存AOF等；另一类被称为文件事件，I/O多路复用函数在处理文件事件时使用，当与文件事件相关联的文件描述符ready即可读或可写时，<code>select</code>等函数返回，Redis使用与ready的文件描述符绑定的函数来处理相应的事件。 与文件描述符绑定的函数可分为三类：</p>
<ol type="1">
<li>AcceptHandler，用来<code>accept</code>客户端的连接，并且把<code>accept</code>后得到的文件描述符设置为非阻塞<code>O_NONBLOCK</code></li>
<li>ReadHandler，用来<code>read</code>客户端发过来的数据，并且每当读到一条完整命令后就执行并把结果写到服务端的与该客户端相对应的缓冲区</li>
<li>WriteHandler，用来把服务端的与客户端对应的缓冲区中的数据<code>write</code>给客户端</li>
</ol>
<p><img src="/images/posts/Redis学习-命令执行/0.jpg" /></p>
<h2 id="readhandler">ReadHandler</h2>
<p>实现逻辑参照<code>src/networking.c:readQueryFromClient</code>。 每当<code>fd</code>可读，尝试读<code>REDIS_IOBUF_LEN=1024*16</code>这么多字节的数据到缓冲区，如果<code>nread=0</code>则断开与<code>fd</code>表示的客户端的链接。 当读到的数据不为空时，持续从缓冲区中尝试解析命令并执行，直到缓冲区已经没有完整命令。</p>
<p><img src="/images/posts/Redis学习-命令执行/1.jpg" /></p>
<h2 id="writehandler">WriteHandler</h2>
<p>实现逻辑参照<code>src/networking.c:sendReplyToClient</code>。 每当<code>fd</code>可写，循环把与<code>fd</code>对应的返回结果缓冲区中的全部数据都发给对应的客户端，直到全部发完或该次事件处理的<code>totwritten &gt; REDIS_MAX_WRITE_PER_EVENT=1024*64</code>或<code>write</code>调用出错。 当<code>write</code>调用出错时，若错误<code>EAGAIN</code>为，则下一轮事件循环再尝试写这个<code>fd</code>；若为其他错误，则关闭与<code>fd</code>对应的客户端连接。</p>
<p><img src="/images/posts/Redis学习-命令执行/2.jpg" /></p>
<hr />
<h1 id="pipeline">Pipeline</h1>
<blockquote>
<p>A Request/Response server can be implemented so that it is able to process new requests even if the client didn't already read the old responses. This way it is possible to send multiple commands to the server without waiting for the replies at all, and finally read the replies in a single step.</p>
</blockquote>
<blockquote>
<p>This is called pipelining, and is a technique widely in use since many decades. For instance many POP3 protocol implementations already supported this feature, dramatically speeding up the process of downloading new emails from the server.</p>
</blockquote>
<blockquote>
<p>Redis has supported pipelining since the very early days, so whatever version you are running, you can use pipelining with Redis. This is an example using the raw netcat utility:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ (printf &quot;PING\r\nPING\r\nPING\r\n&quot;; sleep 1) | nc localhost 6379</span><br><span class="line">+PONG</span><br><span class="line">+PONG</span><br><span class="line">+PONG</span><br></pre></td></tr></table></figure>
<p>引用自<a target="_blank" rel="noopener" href="https://redis.io/topics/pipelining#redis-pipelining" class="uri">https://redis.io/topics/pipelining#redis-pipelining</a>。</p>
<p>按照官方文档，所谓pipeline只是客户端一起把多条命令发给服务端，然后一起读返回结果，而不是每发一条命令读一次返回结果。 在Redis服务端代码中并没有对所谓pipeline的特殊处理，服务端也只是每当能解析出一条命令就执行，然后把返回结果写到缓冲区里，然后在下次事件循环时按照<code>WriteHandler</code>中的逻辑把返回结果<code>write</code>给客户端。</p>
<h2 id="命令行实现pipeline调用">命令行实现pipeline调用</h2>
<p>按照官方文档，下面的命令即实现了一次pipeline调用 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ (printf &#39;*2\r\n$3\r\nget\r\n$5\r\nhello\r\n*3\r\n$3\r\nset\r\n$5\r\nhello\r\n$5\r\nworld\r\n*2\r\n$3\r\nget\r\n$5\r\nhello\r\n*3\r\n$3\r\nset\r\n$8\r\n1 plus 1\r\n$1\r\n2\r\n*2\r\n$3\r\nget\r\n$8\r\n1 plus 1\r\n&#39;; sleep 1) | nc localhost 6379</span><br><span class="line">$-1</span><br><span class="line">+OK</span><br><span class="line">$5</span><br><span class="line">world</span><br><span class="line">+OK</span><br><span class="line">$1</span><br><span class="line">2</span><br></pre></td></tr></table></figure> 修改Redis代码加一些日志后，Redis服务端的输出为： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Poll and handle: START</span><br><span class="line">Fd: 5 is readable</span><br><span class="line">13021:M 12 Dec 17:44:44.657 - Accepted 127.0.0.1:57151</span><br><span class="line">Create file event on fd: 6, mask: readable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:44:44.657 - readQueryFromClient fd: 6, nread: 144</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:44:44.658 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:44:45.638 - readQueryFromClient fd: 6, nread: 0</span><br><span class="line">13021:M 12 Dec 17:44:45.638 - Client closed connection</span><br><span class="line">Delete file event on fd: 6, mask: readable</span><br><span class="line">Poll and handle: END</span><br></pre></td></tr></table></figure> Wireshark抓包的结果： <img src="/images/posts/Redis学习-命令执行/3.png" alt="request" /> <img src="/images/posts/Redis学习-命令执行/4.png" alt="response" /></p>
<h2 id="python实现pipeline调用">Python实现pipeline调用</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    client = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>)</span><br><span class="line">    pipe = client.pipeline(transaction=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span> * <span class="number">1024</span>):</span><br><span class="line">        pipe.set(i, i)</span><br><span class="line">    pipe.execute()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Redis日志： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">Poll and handle: START</span><br><span class="line">Fd: 5 is readable</span><br><span class="line">13021:M 12 Dec 17:47:02.791 - Accepted 127.0.0.1:57168</span><br><span class="line">Create file event on fd: 6, mask: readable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.001 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.003 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.004 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.004 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.005 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.005 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.006 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.007 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.008 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.008 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.010 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.011 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.011 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.012 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.013 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.013 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.014 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.015 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.016 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.017 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.017 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.018 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.018 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.019 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.019 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.021 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.022 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.022 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.024 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.025 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.025 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.026 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.028 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.028 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.029 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.033 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.033 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.034 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.035 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.035 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.037 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.038 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.038 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.039 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.040 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.040 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.042 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.042 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.042 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.043 - readQueryFromClient fd: 6, nread: 10548</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13021:M 12 Dec 17:47:03.044 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13021:M 12 Dec 17:47:03.108 - readQueryFromClient fd: 6, nread: 0</span><br><span class="line">13021:M 12 Dec 17:47:03.108 - Client closed connection</span><br><span class="line">Delete file event on fd: 6, mask: readable</span><br><span class="line">Poll and handle: END</span><br></pre></td></tr></table></figure></p>
<h2 id="包含大量命令的pipeline">包含大量命令的pipeline</h2>
<p>把上面python代码<code>range</code>的参数改为<code>16 * 1024 * 100</code>，出现了<code>13429:M 12 Dec 18:00:18.557 - sendReplyToClient EAGAIN, fd: 6</code>这种日志。</p>
<hr />
<h1 id="多个客户端同时执行pipeline会发生什么">多个客户端同时执行Pipeline会发生什么</h1>
<p><code>range</code>参数改为<code>16 * 1024 * 10</code>，命令行执行<code>python main.py &amp; python main.py</code>。 Redis日志： <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">Poll and handle: START</span><br><span class="line">Fd: 5 is readable</span><br><span class="line">13596:M 12 Dec 18:05:49.267 - Accepted 127.0.0.1:57368</span><br><span class="line">Create file event on fd: 6, mask: readable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 5 is readable</span><br><span class="line">13596:M 12 Dec 18:05:49.269 - Accepted 127.0.0.1:57369</span><br><span class="line">Create file event on fd: 7, mask: readable</span><br><span class="line">Poll and handle: END</span><br><span class="line">13596:M 12 Dec 18:05:53.103 - 2 clients connected (0 slaves), 993008 bytes in use</span><br><span class="line">13596:M 12 Dec 18:05:58.237 - 2 clients connected (0 slaves), 993008 bytes in use</span><br><span class="line">13596:M 12 Dec 18:06:03.371 - 2 clients connected (0 slaves), 993008 bytes in use</span><br><span class="line">13596:M 12 Dec 18:06:08.513 - 2 clients connected (0 slaves), 993008 bytes in use</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.131 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.134 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.134 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.134 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.135 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.136 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">................................</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.283 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 7 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.284 - readQueryFromClient fd: 7, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.285 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.285 - try sendReplyToClient to fd: 7</span><br><span class="line">Delete file event on fd: 7, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.285 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Fd: 7 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.285 - readQueryFromClient fd: 7, nread: 16384</span><br><span class="line">Create file event on fd: 7, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.286 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 7 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.287 - readQueryFromClient fd: 7, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.287 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.287 - try sendReplyToClient to fd: 7</span><br><span class="line">Delete file event on fd: 7, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.288 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Create file event on fd: 6, mask: writeable</span><br><span class="line">Fd: 7 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.288 - readQueryFromClient fd: 7, nread: 16384</span><br><span class="line">Create file event on fd: 7, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.289 - readQueryFromClient fd: 6, nread: 16384</span><br><span class="line">Fd: 7 is readable</span><br><span class="line">13596:M 12 Dec 18:06:09.290 - readQueryFromClient fd: 7, nread: 16384</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.291 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:09.291 - try sendReplyToClient to fd: 7</span><br><span class="line">Delete file event on fd: 7, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">................................</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:19.984 - try sendReplyToClient to fd: 6</span><br><span class="line">13596:M 12 Dec 18:06:19.984 - sendReplyToClient EAGAIN, fd: 6</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:20.121 - try sendReplyToClient to fd: 7</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:20.122 - try sendReplyToClient to fd: 7</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:20.122 - try sendReplyToClient to fd: 7</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:20.122 - try sendReplyToClient to fd: 7</span><br><span class="line">13596:M 12 Dec 18:06:20.122 - sendReplyToClient EAGAIN, fd: 7</span><br><span class="line">Poll and handle: END</span><br><span class="line">................................</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:23.854 - try sendReplyToClient to fd: 7</span><br><span class="line">13596:M 12 Dec 18:06:23.854 - sendReplyToClient EAGAIN, fd: 7</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:24.085 - try sendReplyToClient to fd: 6</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:24.085 - try sendReplyToClient to fd: 6</span><br><span class="line">Delete file event on fd: 6, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:24.192 - try sendReplyToClient to fd: 7</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is writeable</span><br><span class="line">13596:M 12 Dec 18:06:24.192 - try sendReplyToClient to fd: 7</span><br><span class="line">Delete file event on fd: 7, mask: writeable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 6 is readable</span><br><span class="line">13596:M 12 Dec 18:06:26.373 - readQueryFromClient fd: 6, nread: 0</span><br><span class="line">13596:M 12 Dec 18:06:26.373 - Client closed connection</span><br><span class="line">Delete file event on fd: 6, mask: readable</span><br><span class="line">Poll and handle: END</span><br><span class="line">Poll and handle: START</span><br><span class="line">Fd: 7 is readable</span><br><span class="line">13596:M 12 Dec 18:06:26.510 - readQueryFromClient fd: 7, nread: 0</span><br><span class="line">13596:M 12 Dec 18:06:26.510 - Client closed connection</span><br><span class="line">Delete file event on fd: 7, mask: readable</span><br><span class="line">Poll and handle: END</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/11/Redis%E7%AC%94%E8%AE%B0-info%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/11/Redis%E7%AC%94%E8%AE%B0-info%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Redis笔记 info命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-11 16:22:00 16:22:00" itemprop="dateCreated datePublished" datetime="2019-12-11T16:22:00+08:00">2019-12-11 16:22:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>命令具体实现在<code>redis-3.0/src/redis.c:genRedisInfoString</code>。</p>
<h1 id="memory">Memory</h1>
<ul>
<li><code>used_memory</code>是redis通过在每次执行<code>malloc</code>和<code>free</code>等函数的时候维护定义在<code>src/zmalloc.c</code>中的<code>used_memory</code>变量实现的</li>
<li><code>used_memory_rss</code>在linux中是通过读<code>/proc/&#123;pid&#125;/stat</code>这个文件的第24个字段<code>rss</code>得到number of pages the process in real memory然后再乘以<code>sysconf(_SC_PAGESIZE)</code>实现的。<code>sysconf(_SC_PAGESIZE)</code>表示Size of a page in bytes。</li>
<li><code>used_memory_peak</code>Record the max memory used since the server was started.</li>
<li><code>mem_fragmentation_ratio</code>Fragmentation = RSS / allocated-bytes，allocated-bytes即为<code>used_memory</code></li>
</ul>
<h1 id="cpu">CPU</h1>
<ul>
<li><code>used_cpu_user</code>调用<code>getrusage</code>得到的<code>ru_utime</code></li>
<li><code>used_cpu_sys</code>调用<code>getrusage</code>得到的<code>ru_stime</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/06/UNIX%E7%BC%96%E7%A8%8B-GetAddrInfo%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/06/UNIX%E7%BC%96%E7%A8%8B-GetAddrInfo%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">UNIX编程 GetAddrInfo笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-06 15:58:00 15:58:00" itemprop="dateCreated datePublished" datetime="2019-12-06T15:58:00+08:00">2019-12-06 15:58:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>实现参考：</p>
<ul>
<li>《UNIX环境高级编程》16.3.3 地址查询</li>
<li>《UNIX系统编程手册 下》59.10.1</li>
<li>man getaddrinfo</li>
</ul>
<p><code>addr</code>: <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">getnameinfo_str</span><span class="params">(<span class="keyword">const</span> sockaddr *addr, <span class="keyword">socklen_t</span> addrlen, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> host[NI_MAXHOST];</span><br><span class="line">    <span class="keyword">char</span> service[NI_MAXSERV];</span><br><span class="line">    <span class="keyword">int</span> ret = getnameinfo(addr, addrlen, host, <span class="keyword">sizeof</span>(host), service, <span class="keyword">sizeof</span>(service), flags);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;getnameinfo failed, ret: %d, str: %s\n&quot;</span>, ret, gai_strerror(ret));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> host + <span class="built_in">string</span>(<span class="string">&quot;:&quot;</span>) + service;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">work</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span> &amp;host, <span class="keyword">const</span> <span class="built_in">string</span> &amp;service, <span class="keyword">int</span> hints_flags, <span class="keyword">int</span> getaddrinfo_flags)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;host: %s, service: %s, hints_flags: %d, getaddrinfo_flags: %d\n&quot;</span>, host.c_str(), service.c_str(), hints_flags, getaddrinfo_flags);</span><br><span class="line">    addrinfo hints;</span><br><span class="line">    addrinfo *result;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(hints));</span><br><span class="line"></span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line">    hints.ai_family = AF_UNSPEC;</span><br><span class="line">    hints.ai_flags = hints_flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = getaddrinfo(host == <span class="string">&quot;-&quot;</span> ? <span class="literal">NULL</span> : host.c_str(), service == <span class="string">&quot;-&quot;</span> ? <span class="literal">NULL</span> : service.c_str(), &amp;hints, &amp;result);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;getaddrinfo, host: %s, service: %s, ret: %d, str: %s\n&quot;</span>, host.c_str(), service.c_str(), ret, gai_strerror(ret));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (addrinfo *p = result; p != <span class="literal">NULL</span>; p = p-&gt;ai_next) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;addr: %s, flags: %d, family: %d, socktype: %d, procotol: %d\n&quot;</span>,</span><br><span class="line">               getnameinfo_str(p-&gt;ai_addr, p-&gt;ai_addrlen, getaddrinfo_flags).c_str(), p-&gt;ai_flags, p-&gt;ai_family, p-&gt;ai_socktype, p-&gt;ai_protocol);</span><br><span class="line">        <span class="keyword">if</span> (p == result &amp;&amp; (hints_flags &amp; AI_CANONNAME)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;canonname: %s\n&quot;</span>, p-&gt;ai_canonname);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    freeaddrinfo(result);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-----------&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> host, service;</span><br><span class="line">    <span class="keyword">int</span> hints_flags, getaddrinfo_flags;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">cin</span> &gt;&gt; host &gt;&gt; service &gt;&gt; hints_flags &gt;&gt; getaddrinfo_flags) &#123;</span><br><span class="line">        work(host, service, hints_flags, getaddrinfo_flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    work(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;https&quot;</span>, AI_PASSIVE, <span class="number">0</span>);</span><br><span class="line">    work(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;https&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    work(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;https&quot;</span>, AI_PASSIVE | AI_CANONNAME, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    work(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;https&quot;</span>, AI_PASSIVE, <span class="number">0</span>);</span><br><span class="line">    work(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;https&quot;</span>, AI_PASSIVE | AI_CANONNAME, <span class="number">0</span>);</span><br><span class="line">    work(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;https&quot;</span>, AI_PASSIVE | AI_CANONNAME, NI_NUMERICHOST | NI_NUMERICSERV);</span><br><span class="line"></span><br><span class="line">    work(<span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;http&quot;</span>, AI_CANONNAME, <span class="number">0</span>);</span><br><span class="line">    work(<span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;http&quot;</span>, AI_CANONNAME, NI_NUMERICHOST | NI_NUMERICSERV);</span><br><span class="line"></span><br><span class="line">    work(<span class="string">&quot;baidu.com&quot;</span>, <span class="string">&quot;http&quot;</span>, AI_CANONNAME, <span class="number">0</span>);</span><br><span class="line">    work(<span class="string">&quot;baidu.com&quot;</span>, <span class="string">&quot;http&quot;</span>, AI_CANONNAME, NI_NUMERICHOST | NI_NUMERICSERV);</span><br><span class="line"></span><br><span class="line">    work(<span class="string">&quot;google.com&quot;</span>, <span class="string">&quot;http&quot;</span>, AI_CANONNAME, <span class="number">0</span>);</span><br><span class="line">    work(<span class="string">&quot;google.com&quot;</span>, <span class="string">&quot;http&quot;</span>, AI_CANONNAME, NI_NUMERICHOST | NI_NUMERICSERV);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;addr</span><br><span class="line">host: -, service: https, hints_flags: 1, getaddrinfo_flags: 0</span><br><span class="line">addr: :::https, flags: 0, family: 30, socktype: 1, procotol: 6</span><br><span class="line">addr: 0.0.0.0:https, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: -, service: https, hints_flags: 0, getaddrinfo_flags: 0</span><br><span class="line">addr: localhost:https, flags: 0, family: 30, socktype: 1, procotol: 6</span><br><span class="line">addr: localhost:https, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: -, service: https, hints_flags: 3, getaddrinfo_flags: 0</span><br><span class="line">addr: :::https, flags: 0, family: 30, socktype: 1, procotol: 6</span><br><span class="line">canonname: localhost</span><br><span class="line">addr: 0.0.0.0:https, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: 127.0.0.1, service: https, hints_flags: 1, getaddrinfo_flags: 0</span><br><span class="line">addr: localhost:https, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: 127.0.0.1, service: https, hints_flags: 3, getaddrinfo_flags: 0</span><br><span class="line">addr: localhost:https, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">canonname: (null)</span><br><span class="line">-----------</span><br><span class="line">host: 127.0.0.1, service: https, hints_flags: 3, getaddrinfo_flags: 10</span><br><span class="line">addr: 127.0.0.1:443, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">canonname: (null)</span><br><span class="line">-----------</span><br><span class="line">host: localhost, service: http, hints_flags: 2, getaddrinfo_flags: 0</span><br><span class="line">addr: localhost:http, flags: 0, family: 30, socktype: 1, procotol: 6</span><br><span class="line">canonname: localhost</span><br><span class="line">addr: localhost:http, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: localhost, service: http, hints_flags: 2, getaddrinfo_flags: 10</span><br><span class="line">addr: ::1:80, flags: 0, family: 30, socktype: 1, procotol: 6</span><br><span class="line">canonname: localhost</span><br><span class="line">addr: 127.0.0.1:80, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: baidu.com, service: http, hints_flags: 2, getaddrinfo_flags: 0</span><br><span class="line">addr: 220.181.38.148:http, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">canonname: baidu.com</span><br><span class="line">addr: 39.156.69.79:http, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: baidu.com, service: http, hints_flags: 2, getaddrinfo_flags: 10</span><br><span class="line">addr: 220.181.38.148:80, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">canonname: baidu.com</span><br><span class="line">addr: 39.156.69.79:80, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: google.com, service: http, hints_flags: 2, getaddrinfo_flags: 0</span><br><span class="line">addr: hkg07s22-in-f110.1e100.net:http, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">canonname: google.com</span><br><span class="line">addr: hkg07s22-in-x0e.1e100.net:http, flags: 0, family: 30, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br><span class="line">host: google.com, service: http, hints_flags: 2, getaddrinfo_flags: 10</span><br><span class="line">addr: 216.58.199.110:80, flags: 0, family: 2, socktype: 1, procotol: 6</span><br><span class="line">canonname: google.com</span><br><span class="line">addr: 2404:6800:4005:803::200e:80, flags: 0, family: 30, socktype: 1, procotol: 6</span><br><span class="line">-----------</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/04/UNIX%E7%BC%96%E7%A8%8B-TCP%E5%9F%BA%E7%A1%80%E8%AF%BB%E5%86%99%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/04/UNIX%E7%BC%96%E7%A8%8B-TCP%E5%9F%BA%E7%A1%80%E8%AF%BB%E5%86%99%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">UNIX编程 TCP基础读写笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-04 15:30:00 15:30:00" itemprop="dateCreated datePublished" datetime="2019-12-04T15:30:00+08:00">2019-12-04 15:30:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基本tcp客户端与服务器">基本TCP客户端与服务器</h2>
<h3 id="server">Server</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">addr_to_string</span><span class="params">(<span class="keyword">const</span> sockaddr_in *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> addr_str[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *addr_str_ptr = inet_ntop(AF_INET, &amp;addr-&gt;sin_addr, addr_str, <span class="keyword">sizeof</span>(addr_str));</span><br><span class="line">    <span class="keyword">if</span> (addr_str_ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;inet_ntop failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>(addr_str_ptr) + <span class="string">&quot;:&quot;</span> + to_string(ntohs(addr-&gt;sin_port));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">get_sockname_string</span><span class="params">(<span class="keyword">int</span> sockfd)</span> </span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">    <span class="keyword">if</span> (getsockname(sockfd, (sockaddr *) &amp;addr, &amp;len) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;getsockname failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr_to_string(&amp;addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">get_peername_string</span><span class="params">(<span class="keyword">int</span> sockfd)</span> </span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">    <span class="keyword">if</span> (getpeername(sockfd, (sockaddr *) &amp;addr, &amp;len) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;getpeername failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr_to_string(&amp;addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_server</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">const</span> sockaddr *addr, <span class="keyword">socklen_t</span> alen, <span class="keyword">int</span> qlen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span> ((fd = socket(addr-&gt;sa_family, type, <span class="number">0</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;create socket failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;create socket fd: %d, sock_name: %s, peer_name: %s\n&quot;</span>, fd, get_sockname_string(fd).c_str(), get_peername_string(fd).c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(fd, addr, alen) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;bind failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bind socket fd: %d, sock_name: %s, peer_name: %s\n&quot;</span>, fd, get_sockname_string(fd).c_str(), get_peername_string(fd).c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type == SOCK_STREAM || type == SOCK_SEQPACKET) &#123;</span><br><span class="line">        <span class="keyword">if</span> (listen(fd, qlen) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;listen failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">            close(fd);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;listen fd: %d, sock_name: %s, peer_name: %s\n&quot;</span>, fd, get_sockname_string(fd).c_str(), get_peername_string(fd).c_str());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sleep_before_recv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> sleep_after_listen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> qlen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> port = <span class="number">27015</span>;</span><br><span class="line">    <span class="keyword">char</span> *ip = <span class="string">&quot;0.0.0.0&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argc;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[i] == <span class="built_in">string</span>(<span class="string">&quot;--port&quot;</span>)) &#123;</span><br><span class="line">            port = atoi(argv[i + <span class="number">1</span>]);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i] == <span class="built_in">string</span>(<span class="string">&quot;--qlen&quot;</span>)) &#123;</span><br><span class="line">            qlen = atoi(argv[i + <span class="number">1</span>]);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i] == <span class="built_in">string</span>(<span class="string">&quot;--sleep-before-recv&quot;</span>)) &#123;</span><br><span class="line">            sleep_before_recv = atoi(argv[i + <span class="number">1</span>]);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i] == <span class="built_in">string</span>(<span class="string">&quot;--sleep-after-listen&quot;</span>)) &#123;</span><br><span class="line">            sleep_after_listen = atoi(argv[i + <span class="number">1</span>]);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i] == <span class="built_in">string</span>(<span class="string">&quot;--ip&quot;</span>)) &#123;</span><br><span class="line">            ip = argv[i + <span class="number">1</span>];</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;port: %d, qlen: %d, sleep-before-recv: %d, sleep-after-listen: %d\n&quot;</span>, port, qlen, sleep_before_recv, sleep_after_listen);</span><br><span class="line"></span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    bzero(&amp;addr, <span class="keyword">sizeof</span>(addr)); <span class="comment">// APUE 16.3.2 其中成员sin_zero为填充字段，应该全部被置为0</span></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    inet_pton(addr.sin_family, ip, &amp;addr.sin_addr);</span><br><span class="line">    addr.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sockfd = init_server(SOCK_STREAM, (sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(addr), qlen);</span><br><span class="line">    <span class="keyword">if</span> (sockfd == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    sleep(sleep_after_listen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> clfd, n;</span><br><span class="line">        sockaddr_in accepted_addr;</span><br><span class="line">        <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(accepted_addr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((clfd = accept(sockfd, (sockaddr *) &amp;accepted_addr, &amp;len)) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;accept failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;after accept sockfd: %d, sock_name: %s, peer_name: %s\n&quot;</span>,</span><br><span class="line">               sockfd, get_sockname_string(sockfd).c_str(), get_peername_string(sockfd).c_str());</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;accepted fd: %d, sock_name: %s, peer_name: %s, addr: %s\n&quot;</span>,</span><br><span class="line">               clfd, get_sockname_string(clfd).c_str(), get_peername_string(clfd).c_str(), addr_to_string(&amp;accepted_addr).c_str());</span><br><span class="line"></span><br><span class="line">        sleep(sleep_before_recv);</span><br><span class="line">        <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">        <span class="keyword">if</span> ((n = recv(clfd, buf, BUF_SIZE - <span class="number">1</span>, <span class="number">0</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;recv failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">            close(clfd);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        buf[n] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;read %d bytes from fd: %d, buf: %s\n&quot;</span>, n, clfd, buf);</span><br><span class="line">        close(clfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果调用<code>getsockname</code>时没有地址绑定到传入的套接字，则其结果是未定义的。<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<h3 id="client">Client</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">addr_to_string</span><span class="params">(<span class="keyword">const</span> sockaddr_in *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> addr_str[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *addr_str_ptr = inet_ntop(AF_INET, &amp;addr-&gt;sin_addr, addr_str, <span class="keyword">sizeof</span>(addr_str));</span><br><span class="line">    <span class="keyword">if</span> (addr_str_ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;inet_ntop failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>(addr_str_ptr) + <span class="string">&quot;:&quot;</span> + to_string(ntohs(addr-&gt;sin_port));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">get_sockname_string</span><span class="params">(<span class="keyword">int</span> sockfd)</span> </span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">    <span class="keyword">if</span> (getsockname(sockfd, (sockaddr *) &amp;addr, &amp;len) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;getsockname failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr_to_string(&amp;addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">get_peername_string</span><span class="params">(<span class="keyword">int</span> sockfd)</span> </span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    <span class="keyword">socklen_t</span> len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">    <span class="keyword">if</span> (getpeername(sockfd, (sockaddr *) &amp;addr, &amp;len) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;getpeername failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> addr_to_string(&amp;addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> port = <span class="number">27015</span>;</span><br><span class="line">    <span class="keyword">char</span> *ip = <span class="string">&quot;0.0.0.0&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argc;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[i] == <span class="built_in">string</span>(<span class="string">&quot;--port&quot;</span>)) &#123;</span><br><span class="line">            port = atoi(argv[i + <span class="number">1</span>]);</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (argv[i] == <span class="built_in">string</span>(<span class="string">&quot;--ip&quot;</span>)) &#123;</span><br><span class="line">            ip = argv[i + <span class="number">1</span>];</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    bzero(&amp;addr, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(port);</span><br><span class="line">    <span class="keyword">if</span> (inet_pton(addr.sin_family, ip, &amp;addr.sin_addr) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;inet_pton failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sockfd = socket(addr.sin_family, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;create socket failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd: %d, sock_name: %s, peer_name: %s\n&quot;</span>, sockfd, get_sockname_string(sockfd).c_str(), get_peername_string(sockfd).c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect(sockfd, (sockaddr *) &amp;addr, <span class="keyword">sizeof</span>(addr)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;connect failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">        close(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd: %d, sock_name: %s, peer_name: %s\n&quot;</span>, sockfd, get_sockname_string(sockfd).c_str(), get_peername_string(sockfd).c_str());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; msgs = &#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>, <span class="string">&quot;cpp&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;msg : msgs) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = send(sockfd, msg.c_str(), msg.size(), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;send failed, errno: %d, str: %s\n&quot;</span>, errno, strerror(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fd: %d, send %d bytes\n&quot;</span>, sockfd, n);</span><br><span class="line">    &#125;</span><br><span class="line">    close(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="read">Read</h3>
<h4 id="建连后客户端调用三次send服务端在recv之前sleep-0秒">建连后客户端调用三次send，服务端在recv之前sleep 0秒</h4>
<p><code>server</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;server --sleep-before-recv 0</span><br><span class="line">port: 27015, qlen: 0, sleep-before-recv: 0, sleep-after-listen: 0</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">create socket fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">bind socket fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">listen fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:59932, addr: 127.0.0.1:59932</span><br><span class="line">read 5 bytes from fd: 4, buf: hello</span><br><span class="line">^C</span><br></pre></td></tr></table></figure></p>
<p><code>client</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;client</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">fd: 3, sock_name: 127.0.0.1:59932, peer_name: 127.0.0.1:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 3 bytes</span><br></pre></td></tr></table></figure></p>
<h4 id="建连后客户端调用三次send服务端在recv之前sleep-5秒">建连后客户端调用三次send，服务端在recv之前sleep 5秒</h4>
<p><code>server</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;server --sleep-before-recv 5</span><br><span class="line">port: 27015, qlen: 0, sleep-before-recv: 5, sleep-after-listen: 0</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">create socket fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">bind socket fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">listen fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:60018, addr: 127.0.0.1:60018</span><br><span class="line"># 五秒后</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">^C</span><br></pre></td></tr></table></figure></p>
<p><code>client</code>: 先执行服务端，再执行客户端，客服端执行完三次send后未等服务端read就已返回 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;client</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">fd: 3, sock_name: 127.0.0.1:60018, peer_name: 127.0.0.1:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 3 bytes</span><br></pre></td></tr></table></figure></p>
<h3 id="listen-backlog">Listen Backlog</h3>
<h4 id="backlog传2">backlog传2</h4>
<p><code>server</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;server --sleep-after-listen 10 --qlen 2</span><br><span class="line">port: 27015, qlen: 2, sleep-before-recv: 0, sleep-after-listen: 10</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">create socket fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">bind socket fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">listen fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line"># sleep here</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:63689, addr: 127.0.0.1:63689</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:63690, addr: 127.0.0.1:63690</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:63691, addr: 127.0.0.1:63691</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">^C</span><br></pre></td></tr></table></figure></p>
<p><code>client</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;client</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">fd: 3, sock_name: 127.0.0.1:63689, peer_name: 127.0.0.1:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 3 bytes</span><br><span class="line">$ .&#x2F;client</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">fd: 3, sock_name: 127.0.0.1:63690, peer_name: 127.0.0.1:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 3 bytes</span><br><span class="line">$ .&#x2F;client</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line"># block here</span><br><span class="line">fd: 3, sock_name: 127.0.0.1:63691, peer_name: 127.0.0.1:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 3 bytes</span><br></pre></td></tr></table></figure></p>
<h4 id="backlog传0">backlog传0</h4>
<p>参数backlog提供了一个提示，提示系统该进程所要入队的未完成连接请求数量。其实际值由系统决定。具体的最大值取决于每个协议的实现。对于TCP，其默认值为128。<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> 通过下面的脚本，在macOs上测试，验证了TCP的默认值为128。</p>
<p><code>run-server.sh</code> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..256&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;do <span class="variable">$i</span>&quot;</span></span><br><span class="line">    ./client 1&gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$i</span> finished&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p><code>server</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;server --sleep-after-listen 10</span><br><span class="line">port: 27015, qlen: 0, sleep-before-recv: 0, sleep-after-listen: 10</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">create socket fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">bind socket fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">listen fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line"># sleep here</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:63789, addr: 127.0.0.1:63789</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:63790, addr: 127.0.0.1:63790</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">................</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:64050, addr: 127.0.0.1:64050</span><br><span class="line">read 5 bytes from fd: 4, buf: hello</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:64051, addr: 127.0.0.1:64051</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">^C</span><br></pre></td></tr></table></figure></p>
<p><code>client</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;run-server.sh</span><br><span class="line">do 1</span><br><span class="line">1 finished</span><br><span class="line">do 2</span><br><span class="line">2 finished</span><br><span class="line">do 3</span><br><span class="line">3 finished</span><br><span class="line">do 4</span><br><span class="line">4 finished</span><br><span class="line">..................</span><br><span class="line">do 126</span><br><span class="line">126 finished</span><br><span class="line">do 127</span><br><span class="line">127 finished</span><br><span class="line">do 128</span><br><span class="line">128 finished</span><br><span class="line">do 129</span><br><span class="line"># block here</span><br><span class="line">129 finished</span><br><span class="line">do 130</span><br><span class="line">130 finished</span><br><span class="line">do 131</span><br><span class="line">131 finished</span><br><span class="line">do 132</span><br><span class="line">132 finished</span><br><span class="line">..................</span><br><span class="line">do 255</span><br><span class="line">255 finished</span><br><span class="line">do 256</span><br><span class="line">256 finished</span><br></pre></td></tr></table></figure></p>
<h3 id="inaddr_any">INADDR_ANY</h3>
<p>对于因特网域，如果指定IP地址为INADDR_ANY(<code>&lt;netinet/in.h&gt;</code>中定义的)，套接字端点可以被绑定到所有的系统网络接口上。这意味着可以接收这个系统所安装的任何一个网卡的数据包。如果调用connect或listen，但没有将地址绑定到套接字上，系统会选择一个地址绑定到套接字上。<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>可以注意到下面在<code>bind 0.0.0.0</code>后的sockfd在getsockname后得到的ip是<code>0.0.0.0</code>，在accept得到的fd上getsockname后得到的ip才是<code>127.0.0.1</code>或<code>other-ip</code>，而<code>bind other-ip</code>后的sockfd在getsockname后得到的ip就是<code>other-ip</code>。</p>
<h4 id="bind-0.0.0.0">Bind 0.0.0.0</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;server</span><br><span class="line">$ .&#x2F;server --ip 0.0.0.0</span><br><span class="line">port: 27015, qlen: 0, sleep-before-recv: 0, sleep-after-listen: 0</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">create socket fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">bind socket fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">listen fd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: other-ip:27015, peer_name: other-ip:62771, addr: other-ip:62771</span><br><span class="line">read 5 bytes from fd: 4, buf: hello</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: 0.0.0.0:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: 127.0.0.1:27015, peer_name: 127.0.0.1:62772, addr: 127.0.0.1:62772</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;client --ip other-ip</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">fd: 3, sock_name: other-ip:62771, peer_name: other-ip:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">$ .&#x2F;client --ip 127.0.0.1</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">fd: 3, sock_name: 127.0.0.1:62772, peer_name: 127.0.0.1:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 3 bytes</span><br></pre></td></tr></table></figure>
<h4 id="bind-other-ip">Bind other-ip</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;server --ip other-ip</span><br><span class="line">port: 27015, qlen: 0, sleep-before-recv: 0, sleep-after-listen: 0</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">create socket fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">bind socket fd: 3, sock_name: other-ip:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">listen fd: 3, sock_name: other-ip:27015, peer_name:</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">after accept sockfd: 3, sock_name: other-ip:27015, peer_name:</span><br><span class="line">accepted fd: 4, sock_name: other-ip:27015, peer_name: other-ip:62773, addr: other-ip:62773</span><br><span class="line">read 13 bytes from fd: 4, buf: helloworldcpp</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ .&#x2F;client --ip other-ip</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">fd: 3, sock_name: other-ip:62773, peer_name: other-ip:27015</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 5 bytes</span><br><span class="line">fd: 3, send 3 bytes</span><br><span class="line">$ .&#x2F;client --ip 127.0.0.1</span><br><span class="line">getpeername failed, errno: 57, str: Socket is not connected</span><br><span class="line">fd: 3, sock_name: 0.0.0.0:0, peer_name:</span><br><span class="line">connect failed, errno: 61, str: Connection refused</span><br></pre></td></tr></table></figure>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>《UNIX环境高级编程》16.3.4<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>《UNIX环境高级编程》16.4<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>《UNIX环境高级编程》16.3.4<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ToRapture"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">ToRapture</p>
  <div class="site-description" itemprop="description">Some notes</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ToRapture" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ToRapture" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ToRapture" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ToRapture" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:torapture@gmail.com" title="E-Mail → mailto:torapture@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ToRapture</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
