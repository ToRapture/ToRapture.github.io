<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"torapture.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Some notes">
<meta property="og:type" content="website">
<meta property="og:title" content="ToRapture&#39;s Blog">
<meta property="og:url" content="https://torapture.github.io/page/5/index.html">
<meta property="og:site_name" content="ToRapture&#39;s Blog">
<meta property="og:description" content="Some notes">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ToRapture">
<meta property="article:tag" content="ToRapture, Linux">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://torapture.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>ToRapture's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ToRapture's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">A Programmer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/04/12/HDU-2642-Stars/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/12/HDU-2642-Stars/" class="post-title-link" itemprop="url">HDU 2642 Stars</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-12 18:50:00 18:50:00" itemprop="dateCreated datePublished" datetime="2020-04-12T18:50:00+08:00">2020-04-12 18:50:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/04/12/HDU-2642-Stars/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/12/HDU-2642-Stars/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="http://acm.hdu.edu.cn/showproblem.php?pid=2642">Stars</a></p>
<p>Two dimensional binary indexed tree.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DBG(x) cerr &lt;&lt; #x &lt;&lt; <span class="meta-string">&quot; = &quot;</span> &lt;&lt; x &lt;&lt; endl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1002</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Bit</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> c[N][N];</span><br><span class="line">    <span class="keyword">int</span> n, m;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lowbit</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x &amp; -x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;n = n;</span><br><span class="line">        <span class="keyword">this</span>-&gt;m = m;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= m; j++) &#123;</span><br><span class="line">                c[i][j] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = x; i &lt;= n; i += lowbit(i)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = y; j &lt;= m; j += lowbit(j)) &#123;</span><br><span class="line">                c[i][j] += v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> s = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = x; i &gt; <span class="number">0</span>; i -= lowbit(i)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = y; j &gt; <span class="number">0</span>; j -= lowbit(j)) &#123;</span><br><span class="line">                s += c[i][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; bit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> star[N][N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n) != EOF) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = <span class="number">1001</span>;</span><br><span class="line">        bit.init(m, m);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= m; j++) &#123;</span><br><span class="line">                star[i][j] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">char</span> op[<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, op);</span><br><span class="line">            <span class="keyword">if</span> (op[<span class="number">0</span>] == <span class="string">&#x27;B&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> x, y;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">                x++, y++;</span><br><span class="line">                <span class="keyword">if</span> (!star[x][y]) &#123;</span><br><span class="line">                    star[x][y] = <span class="literal">true</span>;</span><br><span class="line">                    bit.add(x, y, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op[<span class="number">0</span>] == <span class="string">&#x27;D&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> x, y;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">                x++, y++;</span><br><span class="line">                <span class="keyword">if</span> (star[x][y]) &#123;</span><br><span class="line">                    star[x][y] = <span class="literal">false</span>;</span><br><span class="line">                    bit.add(x, y, <span class="number">-1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> x1, x2, y1, y2;</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d%d%d%d&quot;</span>, &amp;x1, &amp;x2, &amp;y1, &amp;y2);</span><br><span class="line">                <span class="keyword">if</span> (x1 &gt; x2) &#123;</span><br><span class="line">                    swap(x1, x2);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (y1 &gt; y2) &#123;</span><br><span class="line">                    swap(y1, y2);</span><br><span class="line">                &#125;</span><br><span class="line">                x1++, x2++, y1++, y2++;</span><br><span class="line">                <span class="keyword">int</span> res = bit.get(x2, y2) - bit.get(x1 - <span class="number">1</span>, y2) - bit.get(x2, y1 - <span class="number">1</span>) + bit.get(x1 - <span class="number">1</span>, y1 - <span class="number">1</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, res);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/04/10/236-Lowest-Common-Ancestor-of-a-Binary-Tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/10/236-Lowest-Common-Ancestor-of-a-Binary-Tree/" class="post-title-link" itemprop="url">236. Lowest Common Ancestor of a Binary Tree</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-10 16:51:00 16:51:00" itemprop="dateCreated datePublished" datetime="2020-04-10T16:51:00+08:00">2020-04-10 16:51:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/04/10/236-Lowest-Common-Ancestor-of-a-Binary-Tree/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/10/236-Lowest-Common-Ancestor-of-a-Binary-Tree/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/lowest-common-ancestor-of-a-binary-tree/">236. Lowest Common Ancestor of a Binary Tree</a></p>
<p>If we can find two subtrees of root such that both of them has target, then root is the LCA of p and q. If there is exactly one subtree of root having target and root itself has target, then root is the LCA of p and q too.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(NULL), right(NULL) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    TreeNode *ans;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">hasTarget</span><span class="params">(TreeNode *root, TreeNode *p, TreeNode *q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">bool</span> left = hasTarget(root-&gt;left, p, q);</span><br><span class="line">        <span class="keyword">bool</span> right = hasTarget(root-&gt;right, p, q);</span><br><span class="line">        <span class="keyword">bool</span> mid = root == p || root == q;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((left &amp;&amp; right) || (left &amp;&amp; mid) || (mid &amp;&amp; right)) &#123;</span><br><span class="line">            ans = root;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> left || right || mid;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">TreeNode* <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode* root, TreeNode* p, TreeNode* q)</span> </span>&#123;</span><br><span class="line">        ans = <span class="literal">nullptr</span>;</span><br><span class="line">        hasTarget(root, p, q);</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/04/07/Leetcode-96-Unique-Binary-Search-Trees/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/07/Leetcode-96-Unique-Binary-Search-Trees/" class="post-title-link" itemprop="url">Leetcode 96. Unique Binary Search Trees</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-07 20:02:00 20:02:00" itemprop="dateCreated datePublished" datetime="2020-04-07T20:02:00+08:00">2020-04-07 20:02:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/04/07/Leetcode-96-Unique-Binary-Search-Trees/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/07/Leetcode-96-Unique-Binary-Search-Trees/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/unique-binary-search-trees/">Unique Binary Search Trees</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">numTrees</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// We consider the position of node n in the tree first.</span></span><br><span class="line">        <span class="comment">// Because all nodes on the tree except for node n is less than node,</span></span><br><span class="line">        <span class="comment">// if node n has children, that must be its left child.</span></span><br><span class="line">        <span class="comment">// Node n can have a parent if the value of its parent is less than its.</span></span><br><span class="line">        <span class="comment">// So we separate the n - 1 nodes into 2 parts, the first part is considered to be the parent part of node n,</span></span><br><span class="line">        <span class="comment">// and the second part is considered to be the left child part of node n.</span></span><br><span class="line">        <span class="comment">// We traverse every possible separation, for each separation we add the multiplication of the number of the combination</span></span><br><span class="line">        <span class="comment">// of the two parts to the answer of node n.</span></span><br><span class="line">        <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">dp</span><span class="params">(n + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                dp[i] += dp[j] * dp[i - <span class="number">1</span> - j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/04/04/Search-in-Rotated-Sorted-Array/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/04/Search-in-Rotated-Sorted-Array/" class="post-title-link" itemprop="url">Search in Rotated Sorted Array</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-04 11:05:00 11:05:00" itemprop="dateCreated datePublished" datetime="2020-04-04T11:05:00+08:00">2020-04-04 11:05:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/04/04/Search-in-Rotated-Sorted-Array/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/04/Search-in-Rotated-Sorted-Array/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/search-in-rotated-sorted-array/">33. Search in Rotated Sorted Array</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> l = <span class="number">0</span>, r = nums.size() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] == target) <span class="keyword">return</span> mid;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt; target) &#123;</span><br><span class="line">                <span class="comment">// target on the left side and mid on the right side</span></span><br><span class="line">                <span class="keyword">if</span> (target &gt; nums[r] &amp;&amp; nums[mid] &lt; nums[l]) r = mid - <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// target on the right side and mid on the left side</span></span><br><span class="line">                <span class="keyword">if</span> (target &lt; nums[l] &amp;&amp; nums[mid] &gt; nums[r]) l = mid + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> r = mid - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/04/01/ID-Generator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/01/ID-Generator/" class="post-title-link" itemprop="url">ID Generator</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-01 16:52:00 16:52:00" itemprop="dateCreated datePublished" datetime="2020-04-01T16:52:00+08:00">2020-04-01 16:52:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/04/01/ID-Generator/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/01/ID-Generator/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="implementation">Implementation</h2>
<p>Some details of this implementation borrow from <a target="_blank" rel="noopener" href="https://github.com/sony/sonyflake">sonyflake</a>. Here using 8 bits to represent time in units of 500ms, 4 bits to represent sequence, 4 bits to represent machine. As a result:</p>
<ul>
<li>The lifetime is <span class="math inline">\(2^8 \times 500ms = 128s\)</span></li>
<li>It can work in <span class="math inline">\(2^4 = 16\)</span> distributed machines</li>
<li>It can generate <span class="math inline">\(2^4 = 16\)</span> IDs per <span class="math inline">\(500ms\)</span> at most in a single thread</li>
</ul>
<h3 id="code">Code</h3>
<p><code>server</code>: <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    logger <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/x-cray/logrus-prefixed-formatter&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.SetFormatter(&amp;prefixed.TextFormatter&#123;</span><br><span class="line">        TimestampFormat: <span class="string">&quot;2006-01-02 15:04:05&quot;</span>,</span><br><span class="line">        FullTimestamp:   <span class="literal">true</span>,</span><br><span class="line">        ForceFormatting: <span class="literal">true</span>,</span><br><span class="line">        DisableColors:   <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    logger.SetOutput(os.Stdout)</span><br><span class="line">    logger.SetLevel(logger.DebugLevel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    BitLenTick      = <span class="number">8</span></span><br><span class="line">    BitLenSequence  = <span class="number">4</span></span><br><span class="line">    BitLenMachineID = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    tickTimeUnit = time.Millisecond * <span class="number">500</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> idFlake *IDFlake</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IDFlake <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu sync.Mutex</span><br><span class="line"></span><br><span class="line">    machineID   <span class="keyword">int64</span></span><br><span class="line">    startTick   <span class="keyword">int64</span> <span class="comment">// ticks of the start time of IDFlake from UNIX epoch</span></span><br><span class="line">    elapsedTick <span class="keyword">int64</span> <span class="comment">// elapsed ticks from start tick</span></span><br><span class="line">    sequence    <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">toFlakeTime</span><span class="params">(t time.Time)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.UTC().UnixNano() / <span class="keyword">int64</span>(tickTimeUnit)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIDFlake</span><span class="params">(machineID <span class="keyword">int64</span>, startTime time.Time)</span> *<span class="title">IDFlake</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;IDFlake&#123;</span><br><span class="line">        machineID:   machineID,</span><br><span class="line">        startTick:   toFlakeTime(startTime),</span><br><span class="line">        elapsedTick: <span class="number">0</span>,</span><br><span class="line">        sequence:    <span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *IDFlake)</span> <span class="title">toID</span><span class="params">()</span> <span class="params">(<span class="keyword">uint64</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> f.elapsedTick &gt;= <span class="number">1</span>&lt;&lt;BitLenTick &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;over the time limit&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">uint64</span>(f.elapsedTick&lt;&lt;(BitLenMachineID+BitLenSequence)) | <span class="keyword">uint64</span>(f.machineID&lt;&lt;BitLenSequence) | <span class="keyword">uint64</span>(f.sequence), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *IDFlake)</span> <span class="title">getID</span><span class="params">()</span> <span class="params">(<span class="keyword">uint64</span>, error)</span></span> &#123;</span><br><span class="line">    f.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> f.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    currentTick := toFlakeTime(time.Now()) - f.startTick</span><br><span class="line">    <span class="keyword">if</span> f.elapsedTick &lt; currentTick &#123;</span><br><span class="line">        f.sequence = <span class="number">0</span></span><br><span class="line">        f.elapsedTick = currentTick</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        f.sequence = (f.sequence + <span class="number">1</span>) &amp; (<span class="number">1</span>&lt;&lt;BitLenSequence - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> f.sequence == <span class="number">0</span> &#123;</span><br><span class="line">            f.elapsedTick++</span><br><span class="line">            sleepFor := sleepTime(f.elapsedTick - currentTick)</span><br><span class="line">            time.Sleep(sleepFor)</span><br><span class="line">            logger.Infof(<span class="string">&quot;slept for %.8fms&quot;</span>, sleepFor.Seconds()*<span class="number">1000</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> f.toID()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sleepTime</span><span class="params">(overTick <span class="keyword">int64</span>)</span> <span class="title">time</span>.<span class="title">Duration</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> time.Duration(overTick)*tickTimeUnit - time.Duration(time.Now().UTC().UnixNano())%tickTimeUnit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Decompose</span><span class="params">(id <span class="keyword">uint64</span>)</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">uint64</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">uint64</span>&#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:       id,</span><br><span class="line">        <span class="string">&quot;tick&quot;</span>:     id &gt;&gt; (BitLenMachineID + BitLenSequence),</span><br><span class="line">        <span class="string">&quot;machine&quot;</span>:  (id &gt;&gt; BitLenSequence) &amp; (<span class="number">1</span>&lt;&lt;BitLenMachineID - <span class="number">1</span>),</span><br><span class="line">        <span class="string">&quot;sequence&quot;</span>: id &amp; (<span class="number">1</span>&lt;&lt;BitLenSequence - <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getID</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    id, err := idFlake.getID()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logger.Warnf(<span class="string">&quot;getID error: %v&quot;</span>, err)</span><br><span class="line">        c.JSON(http.StatusOK,</span><br><span class="line">            <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: err.Error(),</span><br><span class="line">            &#125;,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    result := Decompose(id)</span><br><span class="line">    c.JSON(http.StatusOK, result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpRun</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line">    r.GET(<span class="string">&quot;/get_id&quot;</span>, getID)</span><br><span class="line">    r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    idFlake = NewIDFlake(<span class="number">8</span>, time.Now())</span><br><span class="line">    httpRun()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>client</code>: <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res = requests.get(<span class="string">&#x27;http://127.0.0.1:8080/get_id&#x27;</span>).json()</span><br><span class="line">        <span class="keyword">print</span> res</span><br><span class="line">        <span class="keyword">if</span> res.get(<span class="string">&#x27;error&#x27;</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>
<h3 id="run">Run</h3>
<p><code>server</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.</span><br><span class="line"></span><br><span class="line">[GIN-debug] [WARNING] Running in &quot;debug&quot; mode. Switch to &quot;release&quot; mode in production.</span><br><span class="line"> - using env:	export GIN_MODE&#x3D;release</span><br><span class="line"> - using code:	gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] Listening and serving HTTP on :8080</span><br><span class="line">[2020-04-01 16:11:05]  INFO slept for 285.71300000ms</span><br><span class="line">[2020-04-01 16:11:06]  INFO slept for 446.46500000ms</span><br><span class="line">[2020-04-01 16:11:06]  INFO slept for 450.56500000ms</span><br><span class="line">[2020-04-01 16:11:07]  INFO slept for 449.93100000ms</span><br><span class="line">......</span><br><span class="line">[2020-04-01 16:13:08]  INFO slept for 449.52100000ms</span><br><span class="line">[2020-04-01 16:13:09]  INFO slept for 441.43400000ms</span><br><span class="line">[2020-04-01 16:13:09]  INFO slept for 434.80600000ms</span><br><span class="line">[2020-04-01 16:13:10]  INFO slept for 445.62500000ms</span><br><span class="line">[2020-04-01 16:13:10]  INFO slept for 444.83400000ms</span><br><span class="line">[2020-04-01 16:13:11]  INFO slept for 437.82700000ms</span><br><span class="line">[2020-04-01 16:13:11]  WARN getID error: over the time limit</span><br></pre></td></tr></table></figure></p>
<p><code>client</code>: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1024, u&#39;sequence&#39;: 0&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1025, u&#39;sequence&#39;: 1&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1026, u&#39;sequence&#39;: 2&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1027, u&#39;sequence&#39;: 3&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1028, u&#39;sequence&#39;: 4&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1029, u&#39;sequence&#39;: 5&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1030, u&#39;sequence&#39;: 6&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1031, u&#39;sequence&#39;: 7&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1032, u&#39;sequence&#39;: 8&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1033, u&#39;sequence&#39;: 9&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1034, u&#39;sequence&#39;: 10&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1035, u&#39;sequence&#39;: 11&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1036, u&#39;sequence&#39;: 12&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1037, u&#39;sequence&#39;: 13&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1038, u&#39;sequence&#39;: 14&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 4, u&#39;id&#39;: 1039, u&#39;sequence&#39;: 15&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 5, u&#39;id&#39;: 1280, u&#39;sequence&#39;: 0&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 5, u&#39;id&#39;: 1281, u&#39;sequence&#39;: 1&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 5, u&#39;id&#39;: 1282, u&#39;sequence&#39;: 2&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 5, u&#39;id&#39;: 1283, u&#39;sequence&#39;: 3&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 5, u&#39;id&#39;: 1284, u&#39;sequence&#39;: 4&#125;</span><br><span class="line">......</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 254, u&#39;id&#39;: 65037, u&#39;sequence&#39;: 13&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 254, u&#39;id&#39;: 65038, u&#39;sequence&#39;: 14&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 254, u&#39;id&#39;: 65039, u&#39;sequence&#39;: 15&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65280, u&#39;sequence&#39;: 0&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65281, u&#39;sequence&#39;: 1&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65282, u&#39;sequence&#39;: 2&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65283, u&#39;sequence&#39;: 3&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65284, u&#39;sequence&#39;: 4&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65285, u&#39;sequence&#39;: 5&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65286, u&#39;sequence&#39;: 6&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65287, u&#39;sequence&#39;: 7&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65288, u&#39;sequence&#39;: 8&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65289, u&#39;sequence&#39;: 9&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65290, u&#39;sequence&#39;: 10&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65291, u&#39;sequence&#39;: 11&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65292, u&#39;sequence&#39;: 12&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65293, u&#39;sequence&#39;: 13&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65294, u&#39;sequence&#39;: 14&#125;</span><br><span class="line">&#123;u&#39;machine&#39;: 0, u&#39;tick&#39;: 255, u&#39;id&#39;: 65295, u&#39;sequence&#39;: 15&#125;</span><br><span class="line">&#123;u&#39;error&#39;: u&#39;over the time limit&#39;&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/03/31/Token-Bucket-Algorithm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/31/Token-Bucket-Algorithm/" class="post-title-link" itemprop="url">Token Bucket Algorithm</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-31 16:04:00 16:04:00" itemprop="dateCreated datePublished" datetime="2020-03-31T16:04:00+08:00">2020-03-31 16:04:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/31/Token-Bucket-Algorithm/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/31/Token-Bucket-Algorithm/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="reference">Reference</h2>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Token_bucket">Token bucket</a></p>
<blockquote>
<p>Over the long run the output of conformant packets is limited by the token rate, <span class="math inline">\({\displaystyle r}\)</span>.</p>
</blockquote>
<h2 id="implementation">Implementation</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    logger <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/x-cray/logrus-prefixed-formatter&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.SetFormatter(&amp;prefixed.TextFormatter&#123;</span><br><span class="line">        TimestampFormat: <span class="string">&quot;2006-01-02 15:04:05&quot;</span>,</span><br><span class="line">        FullTimestamp:   <span class="literal">true</span>,</span><br><span class="line">        ForceFormatting: <span class="literal">true</span>,</span><br><span class="line">        DisableColors:   <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    logger.SetOutput(os.Stdout)</span><br><span class="line">    logger.SetLevel(logger.DebugLevel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TokenBucket <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu              sync.Mutex</span><br><span class="line">    startTime       time.Time</span><br><span class="line">    availableTokens <span class="keyword">int64</span></span><br><span class="line">    capacity        <span class="keyword">int64</span></span><br><span class="line">    fillInterval    time.Duration</span><br><span class="line">    lastTick        <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTokenBucket</span><span class="params">(qps, capacity <span class="keyword">int64</span>)</span> *<span class="title">TokenBucket</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;TokenBucket&#123;</span><br><span class="line">        startTime:       time.Now(),</span><br><span class="line">        availableTokens: capacity,</span><br><span class="line">        capacity:        capacity,</span><br><span class="line">        lastTick:        <span class="number">0</span>,</span><br><span class="line">        fillInterval:    time.Duration(<span class="keyword">int64</span>(time.Second) / qps),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tb *TokenBucket)</span> <span class="title">adjust</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tb.availableTokens) &gt;= tb.capacity &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    now := time.Now()</span><br><span class="line">    tick := <span class="keyword">int64</span>(now.Sub(tb.startTime) / tb.fillInterval)</span><br><span class="line">    tb.availableTokens += tick - tb.lastTick</span><br><span class="line">    <span class="keyword">if</span> tb.availableTokens &gt; tb.capacity &#123;</span><br><span class="line">        tb.availableTokens = tb.capacity</span><br><span class="line">    &#125;</span><br><span class="line">    tb.lastTick = tick</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tb *TokenBucket)</span> <span class="title">TakeAvailable</span><span class="params">(count <span class="keyword">int64</span>)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">    tb.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> tb.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    tb.adjust()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tb.availableTokens &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> count &gt;= tb.availableTokens &#123;</span><br><span class="line">        count = tb.availableTokens</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tb.availableTokens -= count</span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">task</span><span class="params">(qps, num <span class="keyword">int64</span>, timeNeed time.Duration)</span></span> &#123;</span><br><span class="line">    logger.Infof(<span class="string">&quot;task qps: %v, num: %v, timeNeed: %.3fs&quot;</span>, qps, num, timeNeed.Seconds())</span><br><span class="line">    bucket := NewTokenBucket(qps, qps)</span><br><span class="line">    startTime := time.Now()</span><br><span class="line">    lastTime := startTime</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">int64</span>(<span class="number">1</span>); i &lt;= num; &#123;</span><br><span class="line">        <span class="keyword">if</span> bucket.TakeAvailable(<span class="number">1</span>) == <span class="number">1</span> &#123;</span><br><span class="line">            time.Sleep(timeNeed)</span><br><span class="line">            i++</span><br><span class="line">            <span class="keyword">if</span> i%<span class="number">1000</span> == <span class="number">0</span> &#123;</span><br><span class="line">                now := time.Now()</span><br><span class="line">                logger.Infof(<span class="string">&quot;rate: %.3f&quot;</span>, <span class="number">1000</span>/now.Sub(lastTime).Seconds())</span><br><span class="line">                lastTime = now</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.Infof(<span class="string">&quot;task over, used: %.3fs&quot;</span>, time.Now().Sub(startTime).Seconds())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    task(<span class="number">10000</span>, <span class="number">100000</span>, <span class="number">0</span>)</span><br><span class="line">    task(<span class="number">10000</span>, <span class="number">15000</span>, <span class="number">2</span>*time.Millisecond)</span><br><span class="line">    task(<span class="number">500</span>, <span class="number">10000</span>, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">[2020-03-31 15:58:49]  INFO task qps: 10000, num: 100000, timeNeed: 0.000s</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 6698910.757</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 6132110.182</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 6394802.305</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 6386511.687</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 5484591.041</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 6646770.666</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 5725671.621</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 6449490.813</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 5718631.875</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 6620981.892</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 10174.362</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 9999.993</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 9999.979</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 10000.032</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 9999.993</span><br><span class="line">[2020-03-31 15:58:49]  INFO rate: 10000.001</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 9999.981</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 9750.039</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 10263.124</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 10000.008</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 10000.004</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 10000.006</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 9999.980</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 10000.013</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 10000.008</span><br><span class="line">[2020-03-31 15:58:50]  INFO rate: 9999.989</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 10000.006</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 10000.002</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 10000.002</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 9999.990</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 9999.990</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 10000.004</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 10000.008</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 10000.004</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 9999.999</span><br><span class="line">[2020-03-31 15:58:51]  INFO rate: 9999.994</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 10000.011</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 9999.991</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 9865.780</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 10137.923</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 9999.998</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 10000.009</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 10000.000</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 9999.998</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 10000.000</span><br><span class="line">[2020-03-31 15:58:52]  INFO rate: 10000.000</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 10000.002</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 10000.006</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 9999.994</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 9999.992</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 9999.989</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 10000.026</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 9999.996</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 10000.001</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 9999.975</span><br><span class="line">[2020-03-31 15:58:53]  INFO rate: 10000.015</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 10000.008</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 9999.993</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 10000.011</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 9998.373</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 10001.612</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 10000.003</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 10000.010</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 10000.000</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 10000.000</span><br><span class="line">[2020-03-31 15:58:54]  INFO rate: 9999.988</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 10000.005</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 10000.007</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 9999.996</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 9999.999</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 9999.976</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 10000.032</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 9999.998</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 10000.000</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 9999.990</span><br><span class="line">[2020-03-31 15:58:55]  INFO rate: 10000.001</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 9999.999</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 9999.993</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 10000.012</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 10000.001</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 10000.005</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 9999.996</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 9999.993</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 9999.999</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 10000.008</span><br><span class="line">[2020-03-31 15:58:56]  INFO rate: 9999.996</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 9998.998</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 10001.010</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 9999.992</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 10000.004</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 9999.997</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 9999.988</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 10000.012</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 9999.996</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 10000.012</span><br><span class="line">[2020-03-31 15:58:57]  INFO rate: 9999.998</span><br><span class="line">[2020-03-31 15:58:58]  INFO rate: 9999.991</span><br><span class="line">[2020-03-31 15:58:58]  INFO rate: 9999.990</span><br><span class="line">[2020-03-31 15:58:58]  INFO rate: 10000.020</span><br><span class="line">[2020-03-31 15:58:58]  INFO rate: 9999.995</span><br><span class="line">[2020-03-31 15:58:58]  INFO task over, used: 9.000s</span><br><span class="line">[2020-03-31 15:58:58]  INFO task qps: 10000, num: 15000, timeNeed: 0.002s</span><br><span class="line">[2020-03-31 15:59:00]  INFO rate: 397.098</span><br><span class="line">[2020-03-31 15:59:03]  INFO rate: 396.814</span><br><span class="line">[2020-03-31 15:59:05]  INFO rate: 397.583</span><br><span class="line">[2020-03-31 15:59:08]  INFO rate: 391.641</span><br><span class="line">[2020-03-31 15:59:10]  INFO rate: 391.799</span><br><span class="line">[2020-03-31 15:59:13]  INFO rate: 400.202</span><br><span class="line">[2020-03-31 15:59:15]  INFO rate: 402.581</span><br><span class="line">[2020-03-31 15:59:18]  INFO rate: 405.188</span><br><span class="line">[2020-03-31 15:59:20]  INFO rate: 396.681</span><br><span class="line">[2020-03-31 15:59:23]  INFO rate: 397.131</span><br><span class="line">[2020-03-31 15:59:25]  INFO rate: 398.076</span><br><span class="line">[2020-03-31 15:59:28]  INFO rate: 398.811</span><br><span class="line">[2020-03-31 15:59:30]  INFO rate: 399.199</span><br><span class="line">[2020-03-31 15:59:33]  INFO rate: 400.549</span><br><span class="line">[2020-03-31 15:59:36]  INFO rate: 390.775</span><br><span class="line">[2020-03-31 15:59:36]  INFO task over, used: 37.732s</span><br><span class="line">[2020-03-31 15:59:36]  INFO task qps: 500, num: 10000, timeNeed: 0.000s</span><br><span class="line">[2020-03-31 15:59:37]  INFO rate: 1002.004</span><br><span class="line">[2020-03-31 15:59:39]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:41]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:43]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:45]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:47]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:49]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:51]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:53]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:55]  INFO rate: 500.000</span><br><span class="line">[2020-03-31 15:59:55]  INFO task over, used: 19.000s</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/03/30/External-sort/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/External-sort/" class="post-title-link" itemprop="url">External sort</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-30 18:46:00 18:46:00" itemprop="dateCreated datePublished" datetime="2020-03-30T18:46:00+08:00">2020-03-30 18:46:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/30/External-sort/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/30/External-sort/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="comparison-sorts">Comparison sorts</h2>
<table>
<thead>
<tr class="header">
<th>Name</th>
<th>Best</th>
<th>Average</th>
<th>Worst</th>
<th>Memory</th>
<th>Stable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Bubble sort</td>
<td><span class="math inline">\(n\)</span></td>
<td><span class="math inline">\(n^2\)</span></td>
<td><span class="math inline">\(n^2\)</span></td>
<td><span class="math inline">\(1\)</span></td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Insertion sort</td>
<td><span class="math inline">\(n\)</span></td>
<td><span class="math inline">\(n^2\)</span></td>
<td><span class="math inline">\(n^2\)</span></td>
<td><span class="math inline">\(1\)</span></td>
<td>Yes</td>
</tr>
<tr class="odd">
<td>Merge sort</td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(n\)</span></td>
<td>Yes</td>
</tr>
<tr class="even">
<td>Heapsort</td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(1\)</span></td>
<td>No</td>
</tr>
<tr class="odd">
<td>Quicksort</td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(n\log n\)</span></td>
<td><span class="math inline">\(n^2\)</span></td>
<td><span class="math inline">\(\log n\)</span></td>
<td>No</td>
</tr>
</tbody>
</table>
<h2 id="external-sort">External sort</h2>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/External_sorting">External sorting</a></p>
<p><code>external.cpp</code>: <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DBG(x) cerr &lt;&lt; #x &lt;&lt; <span class="meta-string">&quot; = &quot;</span> &lt;&lt; x &lt;&lt; endl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAX_MEM = <span class="number">128</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 128MB</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">write_temp_file</span><span class="params">(<span class="keyword">int</span> file_no, <span class="keyword">const</span> <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; &amp;strings)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> temp_file = to_string(file_no) + <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">    FILE *f_temp = fopen(temp_file.c_str(), <span class="string">&quot;w&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;s : strings) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(s.c_str(), f_temp);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(f_temp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> temp_file;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; <span class="title">sort_part_to_disk</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span> &amp;input_file)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; temp_files;</span><br><span class="line"></span><br><span class="line">    FILE *f_input = fopen(input_file.c_str(), <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> temp_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> file_no = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; strings;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, f_input) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">string</span> str = buf;</span><br><span class="line">        temp_size += str.size();</span><br><span class="line">        strings.push_back(str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (temp_size &gt;= MAX_MEM) &#123;</span><br><span class="line">            sort(strings.begin(), strings.end());</span><br><span class="line">            <span class="built_in">string</span> temp_file = write_temp_file(file_no, strings);</span><br><span class="line">            temp_files.push_back(temp_file);</span><br><span class="line"></span><br><span class="line">            file_no++;</span><br><span class="line">            strings.clear();</span><br><span class="line">            temp_size = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!strings.empty()) &#123;</span><br><span class="line">        sort(strings.begin(), strings.end());</span><br><span class="line">        <span class="built_in">string</span> temp_file = write_temp_file(file_no, strings);</span><br><span class="line">        temp_files.push_back(temp_file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(f_input);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> temp_files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">external_sort</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span> &amp;input_file, <span class="keyword">const</span> <span class="built_in">string</span> &amp;output_file)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt; temp_files = sort_part_to_disk(input_file);</span><br><span class="line">    <span class="built_in">vector</span>&lt;FILE *&gt; files;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;file_name : temp_files) &#123;</span><br><span class="line">        FILE *temp_file = fopen(file_name.c_str(), <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        files.push_back(temp_file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FILE *f_output = fopen(output_file.c_str(), <span class="string">&quot;w&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">priority_queue</span>&lt;<span class="built_in">pair</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;, <span class="built_in">vector</span>&lt;<span class="built_in">pair</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;&gt;, greater&lt;<span class="built_in">pair</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;&gt;&gt; pri_que;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> have_input = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        have_input = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; temp_files.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">            <span class="keyword">if</span> (fgets(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, files[i]) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                have_input = <span class="literal">true</span>;</span><br><span class="line">                pri_que.push(<span class="built_in">pair</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;(buf, temp_files[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!pri_que.empty()) &#123;</span><br><span class="line">            <span class="built_in">pair</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; top = pri_que.top();</span><br><span class="line">            pri_que.pop();</span><br><span class="line">            <span class="built_in">fputs</span>(top.first.c_str(), f_output);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (have_input || !pri_que.empty());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (FILE *f : files) &#123;</span><br><span class="line">        fclose(f);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(f_output);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    external_sort(<span class="string">&quot;raw.txt&quot;</span>, <span class="string">&quot;output.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> torapture@localhost ~&#x2F;SSD&#x2F;Codes&#x2F;acm ls -lh raw.txt</span><br><span class="line">-rwxrwxrwx  1 torapture  staff   685M  3 30 18:02 raw.txt</span><br><span class="line"></span><br><span class="line"> torapture@localhost ~&#x2F;SSD&#x2F;Codes&#x2F;acm time .&#x2F;external</span><br><span class="line">.&#x2F;external  617.04s user 17.50s system 94% cpu 11:10.99 total</span><br><span class="line"></span><br><span class="line"> torapture@localhost ~&#x2F;SSD&#x2F;Codes&#x2F;acm time sort .&#x2F;raw.txt &gt; sort.txt</span><br><span class="line">sort .&#x2F;raw.txt &gt; sort.txt  496.36s user 87.25s system 81% cpu 11:58.01 total</span><br><span class="line"></span><br><span class="line"> torapture@localhost ~&#x2F;SSD&#x2F;Codes&#x2F;acm ls -lh raw.txt output.txt sort.txt</span><br><span class="line">-rwxrwxrwx  1 torapture  staff   685M  3 30 18:13 output.txt</span><br><span class="line">-rwxrwxrwx  1 torapture  staff   685M  3 30 18:02 raw.txt</span><br><span class="line">-rwxrwxrwx  1 torapture  staff   685M  3 30 18:28 sort.txt</span><br><span class="line"> torapture@localhost ~&#x2F;SSD&#x2F;Codes&#x2F;acm diff output.txt sort.txt</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/03/30/Map-in-Golang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/Map-in-Golang/" class="post-title-link" itemprop="url">Map in Golang</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-30 15:09:00 15:09:00" itemprop="dateCreated datePublished" datetime="2020-03-30T15:09:00+08:00">2020-03-30 15:09:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/30/Map-in-Golang/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/30/Map-in-Golang/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="reference">Reference</h2>
<p><a target="_blank" rel="noopener" href="https://blog.golang.org/maps">Go maps in action</a> <a target="_blank" rel="noopener" href="https://golang.org/ref/spec#Comparison_operators">Comparison operators</a></p>
<h2 id="declaration-and-initialization">Declaration and initialization</h2>
<blockquote>
<p>A Go map type looks like this: <code>map[KeyType]ValueType</code> where KeyType may be any type that is comparable (more on this later), and ValueType may be any type at all, including another map!</p>
</blockquote>
<h2 id="key-types">Key types</h2>
<p>As mentioned earlier, map keys may be of any type that is comparable. The language spec defines this precisely, but in short, comparable types are boolean, numeric, string, pointer, channel, and interface types, and structs or arrays that contain only those types. Notably absent from the list are slices, maps, and functions; these types cannot be compared using ==, and may not be used as map keys.</p>
<h2 id="code">Code</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    logger <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/x-cray/logrus-prefixed-formatter&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.SetFormatter(&amp;prefixed.TextFormatter&#123;</span><br><span class="line">        TimestampFormat: <span class="string">&quot;2006-01-02 15:04:05&quot;</span>,</span><br><span class="line">        FullTimestamp:   <span class="literal">true</span>,</span><br><span class="line">        ForceFormatting: <span class="literal">true</span>,</span><br><span class="line">        DisableColors:   <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    logger.SetOutput(os.Stdout)</span><br><span class="line">    logger.SetLevel(logger.DebugLevel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">    Y <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    mp := <span class="keyword">map</span>[Foo]<span class="keyword">int</span>&#123;</span><br><span class="line">        Foo&#123;</span><br><span class="line">            Y: [...]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;,</span><br><span class="line">        &#125;: <span class="number">256</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    logger.Infof(<span class="string">&quot;mp: %+v&quot;</span>, mp)</span><br><span class="line"></span><br><span class="line">    mp = <span class="keyword">map</span>[Foo]<span class="keyword">int</span>&#123;</span><br><span class="line">        Foo&#123;</span><br><span class="line">            Y: <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>&#123;&#125;,</span><br><span class="line">        &#125;: <span class="number">256</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    logger.Infof(<span class="string">&quot;mp: %+v&quot;</span>, mp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Results: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">panic: runtime error: hash of unhashable type map[int]int</span><br><span class="line">[2020-03-30 15:06:32]  INFO mp: map[&#123;Y:[1 2 3]&#125;:256]</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">main.main()</span><br><span class="line">    &#x2F;Users&#x2F;torapture&#x2F;Codes&#x2F;repos&#x2F;go&#x2F;src&#x2F;go-learn&#x2F;main.go:33 +0x1a2</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2020/03/27/Slice-in-Golang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/27/Slice-in-Golang/" class="post-title-link" itemprop="url">Slice in Golang</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-27 16:24:00 16:24:00" itemprop="dateCreated datePublished" datetime="2020-03-27T16:24:00+08:00">2020-03-27 16:24:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/27/Slice-in-Golang/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/27/Slice-in-Golang/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="blogs">Blogs</h2>
<p><a target="_blank" rel="noopener" href="https://blog.golang.org/slices-intro">Go Slices: usage and internals</a><br />
<a target="_blank" rel="noopener" href="https://blog.golang.org/slices">Arrays, slices (and strings): The mechanics of 'append'</a></p>
<h2 id="details">Details</h2>
<h3 id="make">make</h3>
<p>Look up in <code>$GOROOT/src/runtime/slice.go:makeslice</code>.</p>
<h3 id="append">append</h3>
<p>https://stackoverflow.com/a/33405824/13133551</p>
<h3 id="slicing">slicing</h3>
<blockquote>
<p>The length is the number of elements referred to by the slice. The capacity is the number of elements in the underlying array (beginning at the element referred to by the slice pointer).</p>
</blockquote>
<h3 id="copy">copy</h3>
<p>Look up in <code>$GOROOT/src/runtime/slice.go:slicecopy</code>.</p>
<blockquote>
<p>The copy function supports copying between slices of different lengths (it will copy only up to the smaller number of elements). In addition, copy can handle source and destination slices that share the same underlying array, handling overlapping slices correctly.</p>
</blockquote>
<h2 id="codes">Codes</h2>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    logger <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/x-cray/logrus-prefixed-formatter&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">assertPanic</span><span class="params">(v <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !v &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;v is not true&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.SetFormatter(&amp;prefixed.TextFormatter&#123;</span><br><span class="line">        TimestampFormat: <span class="string">&quot;2006-01-02 15:04:05&quot;</span>,</span><br><span class="line">        FullTimestamp:   <span class="literal">true</span>,</span><br><span class="line">        ForceFormatting: <span class="literal">true</span>,</span><br><span class="line">        DisableColors:   <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    logger.SetOutput(os.Stdout)</span><br><span class="line">    logger.SetLevel(logger.DebugLevel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sliceCopy</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.Infof(<span class="string">&quot;in sliceCopy&quot;</span>)</span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        s = <span class="built_in">append</span>(s, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">copy</span>(c, s)</span><br><span class="line">    logger.Infof(<span class="string">&quot;c: %v&quot;</span>, c)</span><br><span class="line"></span><br><span class="line">    c = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="built_in">copy</span>(c, s)</span><br><span class="line">    logger.Infof(<span class="string">&quot;c: %v&quot;</span>, c)</span><br><span class="line"></span><br><span class="line">    c = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">15</span>)</span><br><span class="line">    <span class="built_in">copy</span>(c, s)</span><br><span class="line">    logger.Infof(<span class="string">&quot;c: %v&quot;</span>, c)</span><br><span class="line"></span><br><span class="line">    c = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>, <span class="number">20</span>)</span><br><span class="line">    <span class="built_in">copy</span>(c, s)</span><br><span class="line">    logger.Infof(<span class="string">&quot;c: %v&quot;</span>, c)</span><br><span class="line"></span><br><span class="line">    c[<span class="number">0</span>] = <span class="number">256</span></span><br><span class="line">    logger.Infof(<span class="string">&quot;c: %v, s: %v&quot;</span>, c, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sliceAppend</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.Infof(<span class="string">&quot;in sliceAppend&quot;</span>)</span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        s = <span class="built_in">append</span>(s, i)</span><br><span class="line">        logger.Infof(<span class="string">&quot;after appending: %v, len(s): %v, cap(s): %v&quot;</span>, i, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        l := <span class="built_in">len</span>(s)</span><br><span class="line">        c := <span class="built_in">cap</span>(s)</span><br><span class="line">        after := <span class="built_in">append</span>(s, i)</span><br><span class="line">        <span class="keyword">if</span> l == c &#123;</span><br><span class="line">            assertPanic(&amp;s[<span class="number">0</span>] != &amp;after[<span class="number">0</span>])</span><br><span class="line">            assertPanic(s[<span class="number">0</span>] == after[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">            s[<span class="number">0</span>] += <span class="number">8</span></span><br><span class="line">            assertPanic(s[<span class="number">0</span>] != after[<span class="number">0</span>])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            assertPanic(&amp;s[<span class="number">0</span>] == &amp;after[<span class="number">0</span>])</span><br><span class="line">            assertPanic(s[<span class="number">0</span>] == after[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">            s[<span class="number">0</span>] += <span class="number">8</span></span><br><span class="line">            assertPanic(s[<span class="number">0</span>] == after[<span class="number">0</span>])</span><br><span class="line">        &#125;</span><br><span class="line">        s = after</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resultOfAppend</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.Infof(<span class="string">&quot;in resultOfAppend&quot;</span>)</span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">64</span>)</span><br><span class="line">    s = <span class="built_in">append</span>(s, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    x := <span class="built_in">append</span>(s, <span class="number">16</span>)</span><br><span class="line">    assertPanic(x[<span class="number">5</span>] == <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    y := <span class="built_in">append</span>(s, <span class="number">32</span>)</span><br><span class="line">    assertPanic(x[<span class="number">5</span>] == <span class="number">32</span>)</span><br><span class="line">    assertPanic(y[<span class="number">5</span>] == <span class="number">32</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slicing</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger.Infof(<span class="string">&quot;in slicing&quot;</span>)</span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">6</span>)</span><br><span class="line">    s = <span class="built_in">append</span>(s, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    y := s[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line">    assertPanic(<span class="built_in">len</span>(y) == <span class="number">2</span>)</span><br><span class="line">    assertPanic(<span class="built_in">cap</span>(y) == <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    y[<span class="number">0</span>] = <span class="number">10</span></span><br><span class="line">    assertPanic(s[<span class="number">1</span>] == <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    y = <span class="built_in">append</span>(y, <span class="number">8</span>)</span><br><span class="line">    assertPanic(s[<span class="number">3</span>] == <span class="number">8</span>)</span><br><span class="line">    assertPanic(y[<span class="number">2</span>] == <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    s[<span class="number">3</span>] = <span class="number">32</span></span><br><span class="line">    assertPanic(y[<span class="number">2</span>] == <span class="number">32</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sliceCopy()</span><br><span class="line">    sliceAppend()</span><br><span class="line">    resultOfAppend()</span><br><span class="line">    slicing()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Result: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[2020-03-27 16:04:59]  INFO in sliceCopy</span><br><span class="line">[2020-03-27 16:04:59]  INFO c: []</span><br><span class="line">[2020-03-27 16:04:59]  INFO c: [0 1 2 3 4]</span><br><span class="line">[2020-03-27 16:04:59]  INFO c: [0 1 2 3 4 5 6 7 8 9 0 0 0 0 0]</span><br><span class="line">[2020-03-27 16:04:59]  INFO c: [0 1 2 3 4]</span><br><span class="line">[2020-03-27 16:04:59]  INFO c: [256 1 2 3 4], s: [0 1 2 3 4 5 6 7 8 9]</span><br><span class="line">[2020-03-27 16:04:59]  INFO in sliceAppend</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 0, len(s): 1, cap(s): 1</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 1, len(s): 2, cap(s): 2</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 2, len(s): 3, cap(s): 4</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 3, len(s): 4, cap(s): 4</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 4, len(s): 5, cap(s): 8</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 5, len(s): 6, cap(s): 8</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 6, len(s): 7, cap(s): 8</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 7, len(s): 8, cap(s): 8</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 8, len(s): 9, cap(s): 16</span><br><span class="line">[2020-03-27 16:04:59]  INFO after appending: 9, len(s): 10, cap(s): 16</span><br><span class="line">[2020-03-27 16:04:59]  INFO in resultOfAppend</span><br><span class="line">[2020-03-27 16:04:59]  INFO in slicing</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://torapture.github.io/2019/12/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%8D%E4%B8%AD%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86%E9%80%92%E5%BD%92%E8%BD%AC%E5%BE%AA%E7%8E%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="ToRapture">
      <meta itemprop="description" content="Some notes">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ToRapture's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%8D%E4%B8%AD%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86%E9%80%92%E5%BD%92%E8%BD%AC%E5%BE%AA%E7%8E%AF/" class="post-title-link" itemprop="url">二叉树前中后序遍历递归转循环</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-29 17:39:00 17:39:00" itemprop="dateCreated datePublished" datetime="2019-12-29T17:39:00+08:00">2019-12-29 17:39:00</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 22:07:40 22:07:40" itemprop="dateModified" datetime="2020-10-11T22:07:40+08:00">2020-10-11 22:07:40</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/12/29/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%8D%E4%B8%AD%E5%90%8E%E5%BA%8F%E9%81%8D%E5%8E%86%E9%80%92%E5%BD%92%E8%BD%AC%E5%BE%AA%E7%8E%AF/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/29/二叉树前中后序遍历递归转循环/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>通过观察递归实现，用循环和栈模拟递归实现中结点入栈和出栈的过程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DBG(x) cerr &lt;&lt; #x &lt;&lt; <span class="meta-string">&quot; = &quot;</span> &lt;&lt; x &lt;&lt; endl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    Node *left, *right;</span><br><span class="line"></span><br><span class="line">    Node() : left(<span class="literal">NULL</span>), right(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    Node(<span class="keyword">int</span> val) : val(val), left(<span class="literal">NULL</span>), right(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> StackState &#123;</span><br><span class="line">    AFTER_PUSH_ROOT = <span class="number">0</span>,</span><br><span class="line">    AFTER_PUSH_LEFT = <span class="number">1</span>,</span><br><span class="line">    AFTER_PUSH_RIGHT = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs_pre_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    ret.push_back(root-&gt;val);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) dfs_pre_order(root-&gt;left, ret);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) dfs_pre_order(root-&gt;right, ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs_in_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) dfs_in_order(root-&gt;left, ret);</span><br><span class="line">    ret.push_back(root-&gt;val);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) dfs_in_order(root-&gt;right, ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs_post_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) dfs_post_order(root-&gt;left, ret);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) dfs_post_order(root-&gt;right, ret);</span><br><span class="line">    ret.push_back(root-&gt;val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pre_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">pair</span>&lt;Node *, StackState&gt;&gt; stk;</span><br><span class="line">    stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(root, AFTER_PUSH_ROOT));</span><br><span class="line">    <span class="keyword">while</span> (!stk.empty()) &#123;</span><br><span class="line">        <span class="built_in">pair</span>&lt;Node *, StackState&gt; &amp;top = stk.top();</span><br><span class="line">        <span class="keyword">switch</span> (top.second) &#123;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_ROOT:</span><br><span class="line">                ret.push_back(top.first-&gt;val);</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;left) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;left, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_LEFT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_LEFT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;right) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;right, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_RIGHT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_RIGHT:</span><br><span class="line">                stk.pop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">in_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">pair</span>&lt;Node *, StackState&gt;&gt; stk;</span><br><span class="line">    stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(root, AFTER_PUSH_ROOT));</span><br><span class="line">    <span class="keyword">while</span> (!stk.empty()) &#123;</span><br><span class="line">        <span class="built_in">pair</span>&lt;Node *, StackState&gt; &amp;top = stk.top();</span><br><span class="line">        <span class="keyword">switch</span> (top.second) &#123;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_ROOT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;left) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;left, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_LEFT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_LEFT:</span><br><span class="line">                ret.push_back(top.first-&gt;val);</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;right) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;right, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_RIGHT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_RIGHT:</span><br><span class="line">                stk.pop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">post_order</span><span class="params">(Node *root, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;ret)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">stack</span>&lt;<span class="built_in">pair</span>&lt;Node *, StackState&gt;&gt; stk;</span><br><span class="line">    stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(root, AFTER_PUSH_ROOT));</span><br><span class="line">    <span class="keyword">while</span> (!stk.empty()) &#123;</span><br><span class="line">        <span class="built_in">pair</span>&lt;Node *, StackState&gt; &amp;top = stk.top();</span><br><span class="line">        <span class="keyword">switch</span> (top.second) &#123;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_ROOT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;left) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;left, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_LEFT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_LEFT:</span><br><span class="line">                <span class="keyword">if</span> (top.first-&gt;right) stk.push(<span class="built_in">pair</span>&lt;Node *, StackState&gt;(top.first-&gt;right, AFTER_PUSH_ROOT));</span><br><span class="line">                top.second = AFTER_PUSH_RIGHT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AFTER_PUSH_RIGHT:</span><br><span class="line">                ret.push_back(top.first-&gt;val);</span><br><span class="line">                stk.pop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Node *<span class="title">get_tree</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    Node *root = <span class="keyword">new</span> Node(random());</span><br><span class="line">    <span class="built_in">vector</span>&lt;Node *&gt; nodes;</span><br><span class="line">    nodes.push_back(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> pos = random() * random() * random() % nodes.size();</span><br><span class="line">        <span class="keyword">if</span> (nodes[pos]-&gt;left == <span class="literal">NULL</span> &amp;&amp; nodes[pos]-&gt;right == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (random() % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                nodes[pos]-&gt;left = <span class="keyword">new</span> Node(random());</span><br><span class="line">                nodes.push_back(nodes[pos]-&gt;left);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nodes[pos]-&gt;right = <span class="keyword">new</span> Node(random());</span><br><span class="line">                nodes.push_back(nodes[pos]-&gt;right);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodes[pos]-&gt;left) &#123;</span><br><span class="line">            nodes[pos]-&gt;right = <span class="keyword">new</span> Node(random());</span><br><span class="line">            nodes.push_back(nodes[pos]-&gt;right);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nodes[pos]-&gt;left = <span class="keyword">new</span> Node(random());</span><br><span class="line">            nodes.push_back(nodes[pos]-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nodes[pos]-&gt;left &amp;&amp; nodes[pos]-&gt;right) &#123;</span><br><span class="line">            nodes.erase(nodes.begin() + pos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_tree</span><span class="params">(Node *root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;left) free_tree(root-&gt;left);</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;right) free_tree(root-&gt;right);</span><br><span class="line">    <span class="keyword">delete</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_pre_order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node *tree = get_tree(<span class="number">100000</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; dfs_ret, ret;</span><br><span class="line"></span><br><span class="line">    dfs_pre_order(tree, dfs_ret);</span><br><span class="line">    pre_order(tree, ret);</span><br><span class="line">    assert(dfs_ret == ret);</span><br><span class="line"></span><br><span class="line">    free_tree(tree);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_in_order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node *tree = get_tree(<span class="number">100000</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; dfs_ret, ret;</span><br><span class="line"></span><br><span class="line">    dfs_in_order(tree, dfs_ret);</span><br><span class="line">    in_order(tree, ret);</span><br><span class="line">    assert(dfs_ret == ret);</span><br><span class="line"></span><br><span class="line">    free_tree(tree);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_post_order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node *tree = get_tree(<span class="number">100000</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; dfs_ret, ret;</span><br><span class="line"></span><br><span class="line">    dfs_post_order(tree, dfs_ret);</span><br><span class="line">    post_order(tree, ret);</span><br><span class="line">    assert(dfs_ret == ret);</span><br><span class="line"></span><br><span class="line">    free_tree(tree);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    test_pre_order();</span><br><span class="line">    test_in_order();</span><br><span class="line">    test_post_order();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ToRapture"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">ToRapture</p>
  <div class="site-description" itemprop="description">Some notes</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">83</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ToRapture" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ToRapture" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/ToRapture" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;ToRapture" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:torapture@gmail.com" title="E-Mail → mailto:torapture@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ToRapture</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://torapture.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
